<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="google-site-verification" content="iplyfI0Y6pOe8NsNYwwrKe-QfSYamSeEhQiDFh93NiU">
    <title>Windows Infrastructure Testing and Compliance with InSpec - chris-rock
    </title>
    <link rel="alternate" href="http://lollyrock.com/feed.xml" type="application/rss+xml" title="fun &amp; sun">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50992958-1', 'lollyrock.com');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript">
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
      
    </script>
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Windows Infrastructure Testing and Compliance with InSpec</h1>
        <p class="author">Written by <span class="author"><a href="mailto:chris@lollyrock.com">Christoph Hartmann</a></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>InSpec is an infrastructure testing and compliance tool that allows you to write re-usable tests for your <span class="caps">IT</span> components. InSpec tests can easily be used in development and production environments to shift <a href="https://blog.chef.io/2016/09/26/shift-left-security-and-compliance-automation-with-inspec-and-chef/">Compliance left</a>. This blog post will highlight how you can leverage InSpec on&nbsp;Windows.</p>
<h2 id="install-inspec-on-windows">Install InSpec on&nbsp;Windows</h2>
<p>First things first: We need InSpec on our workstation. There are two packages that offer an easy way to get started. For production and standalone environments, I recommend the InSpec package. Alternatively there is ChefDK, if you need Chef + Test-Kitchen + InSpec. You can download both packages from <a href="https://downloads.chef.io/">https://downloads.chef.io/</a>.</p>
<p>Another option is to install InSpec via a Powershell&nbsp;script:</p>
<pre><code>. { iwr -useb https://omnitruck.chef.io/install.ps1 } | iex; install -project inspec
</code></pre><p>Once InSpec is installed, run <code>inspec version</code> to verify that the installation was&nbsp;successful.</p>
<h2 id="write-your-first-test">Write your first&nbsp;test</h2>
<p>In my case, I am going to use <a href="https://code.visualstudio.com/">Visual Studio Code</a> to write the InSpec test. Open Powershell and create a new&nbsp;directory:</p>
<pre><code class="lang-ruby"><span class="comment"># create a directory for the test</span>
md inspec
cd .\inspec
<span class="comment"># open Visual Studio Code</span>
code .
</code></pre>
<p><img src="/articles/inspec-windows/inspec-create-dir.png" alt="Create new directory for InSpec tests" title="Create new directory for InSpec tests"></p>
<p>Now, create a new file in Visual Studio Code and write down the first InSpec&nbsp;test:</p>
<pre><code class="lang-ruby">describe service(<span class="string">'<span class="caps">DHCP</span> Client'</span>) <span class="keyword">do</span>
  it { should be_installed }
  it { should be_running }
<span class="keyword">end</span>
</code></pre>
<p>This is all we need to test if the <code>DHCP Client</code> service is installed and running. Save the file and let’s execute the&nbsp;test.</p>
<p><img src="/articles/inspec-windows/vscode-test.png" alt="Write InSpec tests in VSCode" title="Write InSpec tests in VSCode"></p>
<p>Execute InSpec from&nbsp;Powershell:</p>
<pre><code class="lang-bash">inspec <span class="built_in">exec</span> .\test.rb
</code></pre>
<p><img src="/articles/inspec-windows/inspec-exec-test.png" alt="Execute InSpec test" title="Execute InSpec test"></p>
<h2 id="run-inspec-tests-against-a-remote-windows-machine">Run InSpec tests against a remote Windows&nbsp;machine</h2>
<p>I passed the <code>hello world</code> of InSpec by running the first test on our workstation. As a next step, we run the same test against a remote Windows 2012 R2 server. We will use the same InSpec command with additional target&nbsp;information:</p>
<pre><code class="lang-bash">inspec <span class="built_in">exec</span> test.rb -t winrm://Administarator@hostname -p <span class="string">'P@ssword'</span>
</code></pre>
<p><img src="/articles/inspec-windows/inspec-exec-remote.png" alt="Execute InSpec test remotely" title="Execute InSpec test remotely"></p>
<p>With a few commands, we executed an InSpec test against a local workstation and a remote&nbsp;server.</p>
<h2 id="resources-for-windows">Resources for&nbsp;Windows</h2>
<p>Above, we explained how an InSpec test is created and executed. To make this experience great, InSpec ships with a number of resources optimized for Windows environments. Those resources range from core operating system essentials to application&nbsp;components.</p>
<p>Verify Windows settings and&nbsp;configuration:</p>
<ul>
<li><a href="http://inspec.io/docs/reference/resources/file/">file</a></li>
<li><a href="http://inspec.io/docs/reference/resources/package/">package</a></li>
<li><a href="http://inspec.io/docs/reference/resources/port/">port</a></li>
<li><a href="http://inspec.io/docs/reference/resources/registry_key/">registry_key</a></li>
<li><a href="http://inspec.io/docs/reference/resources/service/">service</a></li>
<li><a href="http://inspec.io/docs/reference/resources/user/">user</a></li>
<li><a href="http://inspec.io/docs/reference/resources/users/">users</a></li>
<li><a href="http://inspec.io/docs/reference/resources/windows_feature/">windows_feature</a></li>
<li><a href="http://inspec.io/docs/reference/resources/windows_task/">windows_task</a></li>
<li><a href="http://inspec.io/docs/reference/resources/wmi/">wmi</a></li>
</ul>
<p>Audit Windows security&nbsp;settings:</p>
<ul>
<li><a href="http://inspec.io/docs/reference/resources/audit_policy/">audit_policy</a></li>
<li><a href="http://inspec.io/docs/reference/resources/security_policy/">security_policy</a></li>
</ul>
<p>Run custom&nbsp;scripts:</p>
<ul>
<li><a href="http://inspec.io/docs/reference/resources/powershell/">powershell</a></li>
<li><a href="http://inspec.io/docs/reference/resources/vbscript/">vbscript</a></li>
</ul>
<p>Verify <span class="caps">IIS</span>&nbsp;configuration:</p>
<ul>
<li><a href="http://inspec.io/docs/reference/resources/iis_site/">iis_site</a></li>
</ul>
<p>More resources are available and documented at <a href="http://inspec.io/docs/reference/resources/">InSpec Docs</a>.</p>
<h2 id="verify-configuration-of-the-windows-operating-system">Verify configuration of the Windows operating&nbsp;system</h2>
<p>The following example illustrate the use of the <code>file</code>, <code>user</code>, <code>users</code>, <code>package</code> and <code>windows_taks</code> resource.</p>
<script src="https://gist.github.com/chris-rock/3ab57d7d1bb3d1b813f614f81dcfafbf.js"></script>

<p>The result on my Windows 10 workstation will&nbsp;return:</p>
<p><img src="/articles/inspec-windows/test-win.png" alt="Run InSpec operating system checks" title="Run InSpec operating system checks"></p>
<h2 id="security-checks-for-windows">Security checks for&nbsp;Windows</h2>
<p>If you are interested in operating system hardening for Windows, you need to be able to verify <code>registry_key</code>, <code>security_policy</code> or <code>audit_policy</code>.</p>
<script src="https://gist.github.com/chris-rock/7269ebfbff4f2500e59f922aa9d598fa.js"></script>

<p>Have a look at <a href="https://technet.microsoft.com/en-us/library/jj966254.aspx">Administer Security Policy Settings</a>,<a href="https://technet.microsoft.com/en-us/library/dn221963.aspx">User Rights Assignment</a>, <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb530716.aspx">Privilege Constants</a> and <a href="https://technet.microsoft.com/en-us/library/cc766468.aspx">Audit Policy</a> to learn more about possible&nbsp;settings.</p>
<p><img src="/articles/inspec-windows/test-sec.png" alt="Run security checks" title="Run security checks"></p>
<h2 id="reuse-existing-powershell-or-vbscript-in-inspec">Reuse existing Powershell or VBScript in&nbsp;InSpec</h2>
<p>InSpec also supports running Powershell and VBScript. This allows you to re-use existing scripts inside InSpec. <code>powershell</code> and <code>vbscript</code> resources provide the required capabilities to embed scripts in&nbsp;InSpec.</p>
<pre><code class="lang-ruby">script = <span class="string">&lt;&lt;-<span class="caps">EOH</span>
  Write-Output 'hello'
EOH</span>

describe powershell(script) <span class="keyword">do</span>
  its(<span class="string">'stdout'</span>) { should eq <span class="string">"hello\r\n"</span> }
  its(<span class="string">'stderr'</span>) { should eq <span class="string">''</span> }
<span class="keyword">end</span>
</code></pre>
<p>Besides Powershell, InSpec supports <code>vbscript</code>,&nbsp;too:</p>
<pre><code class="lang-ruby">script = <span class="string">&lt;&lt;-<span class="caps">EOH</span>
  WScript.Echo "hello"
EOH</span>

describe vbscript(script) <span class="keyword">do</span>
  its(<span class="string">'stdout'</span>) { should eq <span class="string">"hello\r\n"</span> }
<span class="keyword">end</span>
</code></pre>
<h2 id="application-testing-with-inspec">Application testing with&nbsp;InSpec</h2>
<p>In addition to operating system checks, we can test <span class="caps">IIS</span> configurations with InSpec as well. The following example demonstrates tests for an out-of-the-box IIS&nbsp;server.</p>
<script src="https://gist.github.com/chris-rock/a079adf369c88ac671b2b0f96f9bb229.js"></script>

<h2 id="compliance">Compliance</h2>
<p>Above, we introduced InSpec as an infrastructure testing tool. For compliance, <a href="http://inspec.io/docs/reference/dsl_inspec/">additional metadata</a> can be attached around <code>describe</code> tests. The following example shows the use of criticality (<code>impact</code>), <code>title</code>, tags (<code>tag</code>) and references (<code>ref</code>).</p>
<pre><code class="lang-ruby">control <span class="string">'windows-base-102'</span> <span class="keyword">do</span>
  impact <span class="number">1.0</span>
  title <span class="string">'Anonymous Access to Windows Shares and Named Pipes is Disallowed'</span>
  tag <span class="symbol">cis:</span> [<span class="string">'windows_2012r2:2.3.11.8'</span>, <span class="string">'windows_2016:2.3.10.9'</span>]
  ref <span class="string">'<span class="caps">CIS</span> Microsoft Windows Server 2012 R2 Benchmark'</span>
  ref <span class="string">'<span class="caps">CIS</span> Microsoft Windows Server 2016 RTM (Release 1607) Benchmark'</span>
  describe registry_key(<span class="string">'<span class="caps">HKLM</span>\System\CurrentControlSet\Services\LanManServer\Parameters'</span>) <span class="keyword">do</span>
    it { should exist }
    its(<span class="string">'RestrictNullSessAccess'</span>) { should eq <span class="number">1</span> }
  <span class="keyword">end</span>
<span class="keyword">end</span>
</code></pre>
<p>In most cases, you do not want to start from scratch to develop compliance benchmarks. The <a href="http://dev-sec.io/">DevSec.io</a> project already provides industry best-practices for Linux and Windows operating systems. The Windows benchmark is currently in development and contributions are welcome to cover more areas. Let’s run the DevSec Windows Baseline&nbsp;quickly:</p>
<pre><code class="lang-ruby">inspec exec <span class="symbol">https:</span>/<span class="regexp">/github.com/dev</span>-sec/windows-baseline
</code></pre>
<p>Are you&nbsp;compliant?</p>
<p><img src="/articles/inspec-windows/test-devsec.png" alt="Run DevSec Windows Baseline" title="Run DevSec Windows Baseline"></p>
<p>I recommend you have a look at the following DevSec&nbsp;profiles:</p>
<ul>
<li><a href="https://github.com/dev-sec/windows-baseline">DevSec Windows&nbsp;Baseline</a></li>
<li><a href="https://github.com/dev-sec/windows-patch-baseline">DevSec Windows Patch&nbsp;Baseline</a></li>
</ul>
<p>Those benchmark already support Windows 2012+, Windows 2016 and Windows&nbsp;Nano.</p>
<h2 id="summary">Summary</h2>
<p>This blog post covered the&nbsp;following:</p>
<ul>
<li>InSpec installation on&nbsp;Windows</li>
<li>InSpec resources for&nbsp;Windows</li>
<li>Execute InSpec tests locally and&nbsp;remotely</li>
<li>InSpec Compliance profiles for&nbsp;Windows</li>
</ul>
<p>You should be prepared to start your first tests with InSpec in your own environment. If you feel that something is missing, please let me&nbsp;know.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="social center">
          <div class="network"><a href="javascript:window.location=%22http://news.ycombinator.com/submitlink?u=%22+encodeURIComponent(document.location)+%22&amp;amp;t=%22+encodeURIComponent(document.title)" class="hn-link">Discuss on Hacker News</a></div>
          <div class="network twitter"><a https://twitter.com/share data-via="chri_hartmann" data-count="none" class="twitter-share-button">Tweet</a></div>
        </div>
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about">
        </section>
        <section class="copy">
          <p>&copy; 2018 Christoph Hartmann &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>