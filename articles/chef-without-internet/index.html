<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="google-site-verification" content="iplyfI0Y6pOe8NsNYwwrKe-QfSYamSeEhQiDFh93NiU">
    <title>Chef without an internet connection / Uninstall Chef with Chef - chris-rock
    </title>
    <link rel="alternate" href="http://lollyrock.com/feed.xml" type="application/rss+xml" title="fun &amp; sun">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50992958-1', 'lollyrock.com');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript">
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
      
    </script>
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Chef without an internet connection / Uninstall Chef with Chef</h1>
        <p class="author">Written by <span class="author"><a href="mailto:chris@lollyrock.com">Christoph Hartmann</a></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>Recently I had a discussion with a DevOps team about an installation of Chef without an internet connection. A normal chef bootstrap fetches the chef binaries via “curl -L <a href="https://www.opscode.com/chef/install.sh">https://www.opscode.com/chef/install.sh</a> | sudo bash”. This will happen, even if you use a Chef Server. Therefore you would require a connection to download the Chef client&nbsp;binaries. </p>
<p>This blog post demonstrates a chef run without an internet connection. Be aware, that we proof the basic setup only. Cookbooks may depend on external urls, but most of them allow attribute overrides to set custom&nbsp;urls.</p>
<h2 id="install-chef-without-internet">Install Chef without&nbsp;internet</h2>
<p>Depending on your operating system, <a href="http://www.getchef.com/chef/install/">Chef provides multiple platform dependent installer</a>. E.g. for Ubuntu you could go&nbsp;with:</p>
<pre><code>wget https://opscode-omnibus-packages.s3.amazonaws.com/ubuntu/13.04/x86_64/chef_11.12.8-2_amd64.deb
</code></pre><p>This enables you to store the binaries on a local server within your internal network. Now, you need to transfer the package on a fresh system and you can install&nbsp;it:</p>
<pre><code class="lang-bash">
<span class="built_in">echo</span> <span class="string">"---&gt; Chef install status:"</span>
dpkg-query -l chef

<span class="built_in">echo</span> <span class="string">"---&gt; Install Chef"</span>
dpkg -i chef_11.12.8-2_amd64.deb

<span class="built_in">echo</span> <span class="string">"---&gt; Chef install status:"</span>
dpkg-query -l chef

<span class="built_in">echo</span> <span class="string">"---&gt; Start chef run"</span>
<span class="comment"># we use chef zero here (-z), if you use a chef server, this would work, too</span>
chef-client -z -o chef-purge

<span class="built_in">echo</span> <span class="string">"---&gt; Chef install status:"</span>
dpkg-query -l chef
</code></pre>
<p>This proofs that we are able to bootstrap a machine with a local chef binary. It would be amazing, if Chef Inc could provide apt and yum repositories. This would allow us to work with the standard operating system setup and we would be able to re-use existing package&nbsp;mirrors.</p>
<h1 id="uninstall-chef-with-chef">Uninstall Chef with&nbsp;Chef</h1>
<p>My customers often asked for a method to do a one-time install of <a href="http://dev-sec.io/">DevSec Hardening Framework</a>. In such a case it would be great, if we could remove the chef installer after the machine&nbsp;bootstrap.</p>
<p>Now fun begins and we proof, that we are able to uninstall the chef binary with a chef&nbsp;cookbook:</p>
<pre><code class="lang-ruby">
<span class="comment">## Uninstall chef</span>
package <span class="string">"chef"</span> <span class="keyword">do</span>
  action <span class="symbol">:purge</span>
<span class="keyword">end</span>
</code></pre>
<p>The console output looks&nbsp;like:</p>
<pre><code class="lang-bash">19:11:34 ∅&gt; vagrant up
Bringing machine <span class="string">'core'</span> up with <span class="string">'virtualbox'</span> provider...
[core] VirtualBox <span class="caps">VM</span> is already running.
19:12:11 ∅&gt; vagrant provision
[core] Running provisioner: shell...
[core] Running: inline script
---&gt; Chef install status:
Desired=Unknown/Install/Remove/Purge/Hold
| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
||/ Name                             Version                           Description
+++-================================-=================================-==============================================================================
un  chef                             &lt;none&gt;                            (no description available)
Selecting previously unselected package chef.
(Reading database ... 61149 files and directories currently installed.)
Unpacking chef (from .../chef_11.12.8-2_amd64.deb) ...
Setting up chef (11.12.8-2) ...
Thank you <span class="keyword">for</span> installing Chef!
---&gt; Chef install status:
Desired=Unknown/Install/Remove/Purge/Hold
| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
||/ Name                             Version                           Description
+++-================================-=================================-==============================================================================
ii  chef                             11.12.8-2                         The full stack of chef
---&gt; Start chef run
[2014-07-14T17:12:31+00:00] <span class="caps">WARN</span>: No config file found or specified on <span class="built_in">command</span> line, using <span class="built_in">command</span> line options.
[2014-07-14T17:12:31+00:00] <span class="caps">INFO</span>: Auto-discovered chef repository at /vagrant
[2014-07-14T17:12:31+00:00] INFO: Starting chef-zero on port 8889 with repository at repository at /vagrant
  One version per cookbook

[2014-07-14T17:12:31+00:00] INFO: Forking chef instance to converge...
[2014-07-14T17:12:31+00:00] WARN: 
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 
SSL validation of HTTPS requests is disabled. HTTPS connections are still
encrypted, but chef is not able to detect forged replies or man <span class="keyword">in</span> the middle
attacks.

To fix this issue add an entry like this to your configuration file:

``
  <span class="comment"># Verify all <span class="caps">HTTPS</span> connections (recommended)</span>
  ssl_verify_mode :verify_peer

  <span class="comment"># <span class="caps">OR</span>, Verify only connections to chef-server</span>
  verify_api_cert <span class="literal">true</span>
``

To check your <span class="caps">SSL</span> configuration, or troubleshoot errors, you can use the
`knife ssl check` <span class="built_in">command</span> like so:

``
  knife ssl check -c 
``

* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 

[2014-07-14T17:12:31+00:00] <span class="caps">INFO</span>: *** Chef 11.12.8 ***
[2014-07-14T17:12:31+00:00] INFO: Chef-client pid: 3311
[2014-07-14T17:12:33+00:00] WARN: Run List override has been provided.
[2014-07-14T17:12:33+00:00] WARN: Original Run List: []
[2014-07-14T17:12:33+00:00] WARN: Overridden Run List: [recipe[chef-purge]]
[2014-07-14T17:12:33+00:00] INFO: Run List is [recipe[chef-purge]]
[2014-07-14T17:12:33+00:00] INFO: Run List expands to [chef-purge]
[2014-07-14T17:12:33+00:00] INFO: Starting Chef Run <span class="keyword">for</span> vagrant-ubuntu-precise-64
[2014-07-14T17:12:33+00:00] <span class="caps">INFO</span>: Running start handlers
[2014-07-14T17:12:33+00:00] INFO: Start handlers complete.
[2014-07-14T17:12:33+00:00] INFO: HTTP Request Returned 404 Not Found : Object not found: /reports/nodes/vagrant-ubuntu-precise-64/runs
[2014-07-14T17:12:33+00:00] INFO: Loading cookbooks [chef-purge@0.1.0]
[2014-07-14T17:12:33+00:00] INFO: Processing file[/root/x.txt] action create (chef-purge::default line 1)
[2014-07-14T17:12:33+00:00] INFO: Processing package[chef] action purge (chef-purge::default line 6)
[2014-07-14T17:12:35+00:00] INFO: package[chef] purged
[2014-07-14T17:12:35+00:00] WARN: Skipping final node save because override_runlist was given
[2014-07-14T17:12:35+00:00] INFO: Chef Run complete <span class="keyword">in</span> 1.445303952 seconds
[2014-07-14T17:12:35+00:00] <span class="caps">INFO</span>: Running report handlers
[2014-07-14T17:12:35+00:00] INFO: Report handlers complete
---&gt; Chef install status:
Desired=Unknown/Install/Remove/Purge/Hold
| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
||/ Name                             Version                           Description
+++-================================-=================================-==============================================================================
un  chef                             &lt;none&gt;                            (no description available)
19:12:40 ∅&gt;
</code></pre>
<h2 id="conclusion">Conclusion</h2>
<ol>
<li><p>It is possible to install the Chef client without an internet connection, but unfortunately Chef is not available via normal package systems like apt and&nbsp;yum. </p>
</li>
<li><p>Chef binaries can be un-installed with a Chef&nbsp;run</p>
</li>
</ol>
<p>The full demo is available at <a href="https://github.com/chris-rock/chef-purge-demo/">Github</a>. Do you have better approaches for running Chef runs without&nbsp;internet?</p>
<p>If you have any questions contact me via <a href="https://twitter.com/chri_hartmann">Twitter @chri_hartmann</a> or <a href="https://github.com/chris-rock">Github</a></p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="social center">
          <div class="network"><a href="javascript:window.location=%22http://news.ycombinator.com/submitlink?u=%22+encodeURIComponent(document.location)+%22&amp;amp;t=%22+encodeURIComponent(document.title)" class="hn-link">Discuss on Hacker News</a></div>
          <div class="network twitter"><a https://twitter.com/share data-via="chri_hartmann" data-count="none" class="twitter-share-button">Tweet</a></div>
        </div>
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about">
        </section>
        <section class="copy">
          <p>&copy; 2017 Christoph Hartmann &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>