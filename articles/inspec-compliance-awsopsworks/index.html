<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="google-site-verification" content="iplyfI0Y6pOe8NsNYwwrKe-QfSYamSeEhQiDFh93NiU">
    <title>Achieve compliance with AWS OpsWorks for Chef Automate - chris-rock
    </title>
    <link rel="alternate" href="http://lollyrock.com/feed.xml" type="application/rss+xml" title="fun &amp; sun">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50992958-1', 'lollyrock.com');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript">
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
      
    </script>
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Achieve compliance with AWS OpsWorks for Chef Automate</h1>
        <p class="author">Written by <span class="author"><a href="mailto:chris@lollyrock.com">Christoph Hartmann</a></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>This example demonstrates how to implement continuous compliance in <span class="caps">AWS</span> environments with <a href="https://www.inspec.io/">InSpec</a>, <a href="https://www.chef.io/chef/">Chef</a> and <a href="https://www.chef.io/automate/">Chef Automate</a>.</p>
<h2 id="overview">Overview</h2>
<p>The demo is based on a <a href="https://youtu.be/4dvN9IsKSgc">webinar</a> presented by <a href="https://twitter.com/markhasread">Mark Rambow</a> and <a href="https://twitter.com/chri_hartmann">me</a>. This post follows the pattern of the webinar by showcasing how continuous compliance is applied with <span class="caps">AWS</span> OpsWorks. Since OpsWorks is based on Chef Automate, it works very similar with Chef Automate&nbsp;standalone.</p>
<p>The example is split in three&nbsp;sections:</p>
<ul>
<li>Setup continuous compliance on one new&nbsp;instance</li>
<li>Scale continuously with&nbsp;auto-scaling</li>
<li>Use a custom InSpec&nbsp;profile</li>
</ul>
<p>Let’s get&nbsp;started.</p>
<h2 id="preparation">Preparation</h2>
<p>We need some pieces&nbsp;upfront:</p>
<ul>
<li>A running <a href="https://aws.amazon.com/opsworks/chefautomate/">OpsWorks Chef Automate</a>&nbsp;instance</li>
<li><a href="https://docs.aws.amazon.com/opsworks/latest/userguide/opscm-unattend-assoc.html#opscm-create-instance-profile"><span class="caps">IAM</span> roles and policies</a> are setup, see&nbsp;<span class="caps">FAQ</span></li>
<li><a href="https://downloads.chef.io/chefdk">ChefDK</a> is installed on your&nbsp;workstation</li>
<li><a href="https://github.com/chris-rock/opsworks-example">OpsWorks&nbsp;StarterKit</a></li>
</ul>
<p>Note: This kit does not include the <code>.chef</code> directory since it contains private credentials. The <code>userdata.sh</code> and <code>userdata.ps1</code> are not generated for your environment. You need to <a href="https://docs.aws.amazon.com/opsworks/latest/userguide/opscm-unattend-assoc.html#w2ab2b9c27c19">adapt it</a> or replace it with the one from your starter&nbsp;kit.</p>
<h2 id="get-started">Get&nbsp;Started</h2>
<p>As the first step, we need to download the kit and upload all cookbooks to the Chef Server that is embedded in&nbsp;OpsWorks.</p>
<pre><code class="lang-bash"><span class="comment"># clone repository</span>
git <span class="built_in">clone</span> git@github.com:chris-rock/opsworks-example.git

<span class="comment"># ensure .chef directory is there or chefdk is </span>

<span class="comment"># bundles all cookbooks and dependens from Berksfile in cookbooks directory</span>
$ berks vendor cookbooks

<span class="comment"># upload all cookbooks to Chef Server</span>
$ berks upload
</code></pre>
<h3 id="detect-and-correct-for-one-aws-instance">Detect and Correct for one <span class="caps">AWS</span>&nbsp;instance</h3>
<p><strong>See Chef client reporting to&nbsp;Automate</strong></p>
<p>We are ready to define the Chef role that we want to apply to our new <span class="caps">EC2</span> instance. Adapt the role <code>roles/webserver.rb</code> to ensure it looks&nbsp;like:</p>
<pre><code class="lang-ruby">name <span class="string">"webserver"</span>
description <span class="string">"Example webserver"</span>

run_list(
  <span class="string">"recipe[chef-client]"</span>,
  <span class="string">"recipe[nginx]"</span>,
  <span class="string">"recipe[inspec-page]"</span>,
)
</code></pre>
<p>This role configures the chef-client, installs nginx and setups the inspec page in nginx. The operating system is not hardened in that example yet. Upload the role to Chef&nbsp;Server:</p>
<pre><code>$ knife upload role roles/webserver.rb
Created roles/webserver.json
</code></pre><p>We’ve done all the require preparation and we are ready to start our first Amazon Linux instance. I’ve used the Amazon Linux 2017.09 with t2.micro. <span class="caps">SSH</span> and HTTPs are the only entries required in your security group configuration. When you reach the instance details section, please make sure the correct IAM instance profile is selected and the userdata contains your role <code>RUN_LIST=&quot;role[webserver]&quot;</code>.</p>
<p><img src="/articles/inspec-compliance-awsopsworks/images/ec2-instance-setup.png" alt="Start EC2 instance with userdata"></p>
<p>Once the instance is up and running, <code>chef-client</code> is executed automatically since it was configured in userdata. The clients pulls the required Chef role and the cookbooks from Chef&nbsp;Server</p>
<p><img src="/articles/inspec-compliance-awsopsworks/images/ec2-instance-start.png" alt="Instance is started"></p>
<p>Once the <code>chef-client</code> finished its first run, you see instance reporting its run list to Chef&nbsp;Automate.</p>
<p><img src="/articles/inspec-compliance-awsopsworks/images/automate-nodes.png" alt="Chef Client reports to Automate"></p>
<p><strong>Run audit&nbsp;scan</strong></p>
<p>So far, we configured the automation, but not compliance scans. We are going to apply the <a href="http://dev-sec.io/">DevSec</a> <span class="caps">SSH</span> Baseline. In Automate’s compliance profile section, load the profile into your namespace. The DevSec profiles are part of the Chef Automate&nbsp;package.</p>
<p><img src="/articles/inspec-compliance-awsopsworks/images/automate-profile-install.png" alt="Install profile into your namespace">
<img src="/articles/inspec-compliance-awsopsworks/images/automate-profile-overview.png" alt="Profile overview"></p>
<p>Once the profile is in your namespace, update the <code>webserver</code> role with the <a href="https://github.com/chef-cookbooks/audit">audit cookbook</a> and ensure the audit cookbook is uploaded to the Chef Server by adding it to the <code>Berksfile</code>: </p>
<pre><code class="lang-ruby">cookbook <span class="string">'audit'</span>
</code></pre>
<p>If you changed the Berksfile,&nbsp;run</p>
<pre><code class="lang-bash">$ berks vendor cookbooks
$ berks upload
</code></pre>
<p>To configure the <code>audit</code> cookbook, adapt the role as&nbsp;following:</p>
<pre><code class="lang-ruby">name <span class="string">"webserver"</span>
description <span class="string">"Example webserver"</span>

default_attributes <span class="string">"audit"</span> =&gt; {
    <span class="string">"reporter"</span> =&gt; <span class="string">"chef-server-automate"</span>,
    <span class="string">"profiles"</span> =&gt; [
        {
            <span class="string">"name"</span>: <span class="string">"ssh-baseline"</span>,
            <span class="string">"compliance"</span>: <span class="string">"admin/ssh-baseline"</span>
        },
    ]
}

run_list(
  <span class="string">"recipe[chef-client]"</span>,
  <span class="string">"recipe[nginx]"</span>,
  <span class="string">"recipe[inspec-page]"</span>,
  <span class="string">"recipe[audit]"</span>
)
</code></pre>
<p>The run list includes <code>&quot;recipe[audit]&quot;</code> now and the <code>audit</code> attributes let the audit cookbook know to use its <code>chef-server-automate</code> reporter. All the InSpec reports are sent via the Chef Server to Chef Automate. <code>admin/ssh-baseline</code> is the namespace that you see in Chef Automate’s profile overview. Once everything is setup properly, you see the ssh baseline reporting to Chef&nbsp;Automate.</p>
<p><img src="/articles/inspec-compliance-awsopsworks/images/automate-not-compliant.png" alt="InSpec reports DevSec SSH Baseline to Chef Automate"></p>
<p><strong>Apply server&nbsp;hardening</strong></p>
<p>Of course, we do not want to tackle the server hardening manually. There is a cookbook for that and we are applying the <a href="https://github.com/dev-sec/chef-ssh-hardening/">DevSec <span class="caps">SSH</span> hardening cookbook</a> via our run&nbsp;list.</p>
<pre><code class="lang-ruby">name <span class="string">"webserver"</span>
description <span class="string">"Example webserver"</span>

default_attributes <span class="string">"audit"</span> =&gt; {
    <span class="string">"reporter"</span> =&gt; <span class="string">"chef-server-automate"</span>,
    <span class="string">"profiles"</span> =&gt; [
        {
            <span class="string">"name"</span>: <span class="string">"ssh-baseline"</span>,
            <span class="string">"compliance"</span>: <span class="string">"admin/ssh-baseline"</span>
        },
    ]
}

run_list(
  <span class="string">"recipe[chef-client]"</span>,
  <span class="string">"recipe[ssh-hardening]"</span>,
  <span class="string">"recipe[nginx]"</span>,
  <span class="string">"recipe[inspec-page]"</span>,
  <span class="string">"recipe[audit]"</span>,
)
</code></pre>
<p><img src="/articles/inspec-compliance-awsopsworks/images/automate-compliant.png" alt="Chef Client reports to Automate">
<img src="/articles/inspec-compliance-awsopsworks/images/automate-compliant-detail.png" alt="Chef Client reports to Automate"></p>
<h3 id="scale-continuous-compliance-with-autoscaling">Scale continuous compliance with&nbsp;autoscaling</h3>
<p>We’ve prepared everything you need. To scale the detection and correction automatically, we are going to apply the role for more servers. In practice you would tie the application deployment with the hardening in one role, but we keep it for&nbsp;simplicity.</p>
<p>As the first step, we are creating a new auto scaling group with a new launch&nbsp;configuration:</p>
<p><img src="/articles/inspec-compliance-awsopsworks/images/auto-1.png" alt="Create a new AWS Auto Scaling group">
<img src="/articles/inspec-compliance-awsopsworks/images/auto-3.png" alt="Use cloudinit to setup node configuration"></p>
<p>Setup the correct security group for each instance:
<img src="/articles/inspec-compliance-awsopsworks/images/auto-4.png" alt="Security group configuration"></p>
<p>Add custom tags for your auto scaling group:
<img src="/articles/inspec-compliance-awsopsworks/images/auto-5.png" alt="Attach tags to auto scaling">
<img src="/articles/inspec-compliance-awsopsworks/images/auto-6.png" alt="Custom Profile reports to Chef Automate"></p>
<p>Once everything is configured, <span class="caps">AWS</span> will launch new instances that spin up Chef to harden the system and verify the compliance state with&nbsp;InSpec.</p>
<p><img src="/articles/inspec-compliance-awsopsworks/images/auto-7.png" alt="Custom Profile reports to Chef Automate"></p>
<p>By combining InSpec for detection with Chef for hardening, we are able to scale our secure infrastructure&nbsp;effortless.</p>
<p><img src="/articles/inspec-compliance-awsopsworks/images/auto-8.png" alt="Compliant System"></p>
<h3 id="use-custom-profile">Use custom&nbsp;profile</h3>
<p>In most cases, the built-in <a href="https://www.cisecurity.org/"><span class="caps">CIS</span></a> and <a href="http://dev-sec.io/">DevSec</a> profiles help users to meet about 80% of their compliance goals. InSpec is very flexible and allows you to implement <a href="http://lollyrock.com/articles/chef-compliance-meta-profiles/">aggregated profiles</a> or <a href="https://www.inspec.io/docs/reference/profiles/#using-controls-from-an-included-profile">profile overlays</a>. If you have in-house applications or custom requirements, InSpec is the tool that helps you to implement those as well. In our case, we are using a profile that allows us to verify instance&nbsp;tags.</p>
<pre><code class="lang-bash"><span class="comment"># clone the InSpec profile to verify <span class="caps">EC2</span> metadata</span>
git <span class="built_in">clone</span> git@github.com:chris-rock/ec2-example-profile.git

<span class="comment"># package the InSpec profile for an upload</span>
inspec archive ec2-metadata-example
</code></pre>
<p>Now, we are going to upload the generated <code>tar.gz</code> file to Chef&nbsp;Automate:</p>
<p><img src="/articles/inspec-compliance-awsopsworks/images/automate-profile-upload.png" alt="Upload InSpec profile to Chef Automate"></p>
<p>Once the profile is upload to Chef Automate, we simply need to update your role and add the new <code>admin/ec2-example-profile</code> profile.</p>
<pre><code class="lang-ruby">name <span class="string">"webserver"</span>
description <span class="string">"Example webserver"</span>

default_attributes <span class="string">"audit"</span> =&gt; {
    <span class="string">"reporter"</span> =&gt; <span class="string">"chef-server-automate"</span>,
    <span class="string">"profiles"</span> =&gt; [
        {
            <span class="string">"name"</span>: <span class="string">"ssh-baseline"</span>,
            <span class="string">"compliance"</span>: <span class="string">"admin/ssh-baseline"</span>,
        },{
            <span class="string">"name"</span>: <span class="string">"ec2-example-profile"</span>,
            <span class="string">"compliance"</span>: <span class="string">"admin/ec2-example-profile"</span>,
        }
    ]
}

run_list(
  <span class="string">"recipe[chef-client]"</span>,
  <span class="string">"recipe[ssh-hardening]"</span>,
  <span class="string">"recipe[nginx]"</span>,
  <span class="string">"recipe[inspec-page]"</span>,
  <span class="string">"recipe[audit]"</span>,
)
</code></pre>
<p>The next time the <code>chef-client</code> executes on each node, the profile will be executed&nbsp;automatically.</p>
<p><img src="/articles/inspec-compliance-awsopsworks/images/automate-profile-report.png" alt="Custom Profile reports to Chef Automate"></p>
<h2 id="summary">Summary</h2>
<p>This post demonstrated the implementation of compliance measures in your fleet by integrating InSpec into your DevOps workflow. If you have any question, do not hesitate to raise an issue in my <a href="https://github.com/chris-rock/opsworks-example">opsworks example</a>.</p>
<h2 id="faq"><span class="caps">FAQ</span></h2>
<p><strong>How do I setup instance&nbsp;permissions</strong></p>
<p>The used cloudinit userdata requires access to the <span class="caps">AWS</span> api via the AWS Cli. Setup the following policy named eg. <code>opsworks-cm</code> in <span class="caps">AWS</span>. Attach this policy to a role named <code>opsworks-cm-role</code>.</p>
<pre><code class="lang-json">{
  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,
  <span class="attr">"Statement"</span>: [
    {
      <span class="attr">"Action"</span>: [
        <span class="string">"opsworks-cm:AssociateNode"</span>,
        <span class="string">"opsworks-cm:DescribeNodeAssociationStatus"</span>,
        <span class="string">"ec2:DescribeTags"</span>,
      ],
      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,
      <span class="attr">"Resource"</span>: [
        <span class="string">"*"</span>
      ]
    }
  ]
}
</code></pre>
<p><img src="/articles/inspec-compliance-awsopsworks/images/iam-policy.png" alt="Create a new IAM Policy">
<img src="/articles/inspec-compliance-awsopsworks/images/iam-role.png" alt="Attach policy to a IAM role"></p>
<p><strong>My node is not showing up in Chef&nbsp;Automate?</strong></p>
<p>If the instance does not report to Chef Automate, it is very likely a <span class="caps">AWS</span> API permission issue. If you see an issue&nbsp;like</p>
<pre><code>An error occurred (AccessDeniedException) when calling the AssociateNode operation:
User: arn:aws:sts::862552916454:assumed-role/aws-opsworks-cm-ec2-role/i-022db13089f495a34
is not authorized to perform: opsworks-cm:AssociateNode on resource:
arn:aws:opsworks-cm:eu-central-1:862552916454:server/opsworks/*
</code></pre><p>in your <code>/var/log/cloud-init-output.log</code> you need to ensure the instance has the correct <span class="caps">IAM</span> instance profile as explain on <a href="https://docs.aws.amazon.com/opsworks/latest/userguide/opscm-unattend-assoc.html#opscm-create-instance-profile"><span class="caps">AWS</span> docs</a>.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="social center">
          <div class="network"><a href="javascript:window.location=%22http://news.ycombinator.com/submitlink?u=%22+encodeURIComponent(document.location)+%22&amp;amp;t=%22+encodeURIComponent(document.title)" class="hn-link">Discuss on Hacker News</a></div>
          <div class="network twitter"><a https://twitter.com/share data-via="chri_hartmann" data-count="none" class="twitter-share-button">Tweet</a></div>
        </div>
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about">
        </section>
        <section class="copy">
          <p>&copy; 2018 Christoph Hartmann &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>