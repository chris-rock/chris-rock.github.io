<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="google-site-verification" content="iplyfI0Y6pOe8NsNYwwrKe-QfSYamSeEhQiDFh93NiU">
    <title>Google Cloud Platform support for InSpec - chris-rock
    </title>
    <link rel="alternate" href="http://lollyrock.com/feed.xml" type="application/rss+xml" title="fun &amp; sun">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50992958-1', 'lollyrock.com');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript">
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
      
    </script>
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Google Cloud Platform support for InSpec</h1>
        <p class="author">Written by <span class="author"><a href="mailto:chris@lollyrock.com">Christoph Hartmann</a></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>When we released <a href="https://techcrunch.com/2018/02/20/chef-inspec-2-0-wants-to-help-companies-automate-security-compliance-in-cloud-apps/">InSpec 2.0</a> in February 2018, it shipped with native support for <span class="caps">AWS</span> and Azure. Over the course of the last 3 months, the InSpec team and community kept adding more AWS and Azure resources. We also showcased how <a href="http://lollyrock.com/articles/inspec-terraform/">Terraform can be tested effectively with InSpec</a>. In parallel, we worked on Google Cloud Platform (<span class="caps">GCP</span>) support which is now&nbsp;available.</p>
<h2 id="verify-google-cloud-platform-resources">Verify Google Cloud Platform&nbsp;resources</h2>
<center>
<img src="/articles/inspec-cloud-gcp-setup/inspec-gcp.png" alt="Google Cloud Platform and InSpec" title="Google Cloud Platform support for InSpec">
</center>

<p>We wanted to extend the cloud support for a while and the InSpec community has been super fast in its adoption! <a href="https://github.com/martezr/inspec-gcp">Martez Reed</a> pushed an early-prototype right after InSpec 2.0 has been announced and <a href="https://github.com/chef/inspec/issues/2722">Thomas Poindessous</a> brought up the needs for <span class="caps">GCP</span> support in the community. We’ve listened and worked with Google to get GCP support into&nbsp;InSpec.</p>
<p>To get native <span class="caps">GCP</span> support, we added <a href="https://github.com/chef/train/pull/283"><span class="caps">GCP</span> support in Train</a> and worked on <a href="https://github.com/inspec/inspec-gcp">InSpec <span class="caps">GCP</span> Resources</a>. The resource pack is like an InSpec profile with custom resources but without any controls. This resource pack allows us to improve the stability and documentation of the resources before we bring them into core InSpec. <a href="https://github.com/skpaterson">Stuart Paterson</a> built those resources on top of Martez’s ideas. Now, let’s see how this works in&nbsp;practice.</p>
<h2 id="preparation">Preparation</h2>
<p>InSpec <span class="caps">GCP</span> resources require a GCP client ID and secret. The easiest way to set up the credentials is via the Google SDK. Please install and configure the GCP SDK by downloading the <a href="https://cloud.google.com/sdk/docs/"><span class="caps">SDK</span></a> and running the installation via <code>./google-cloud-sdk/install.sh</code>. Once everything is installed, we are ready to gather the&nbsp;credentials: </p>
<pre><code>gcloud auth application-default login
cat ~/.config/gcloud/application_default_credentials.json 
{
  &quot;client_id&quot;: &quot;764086051850-6qp4p6gpi6in60asdr.apps.googleusercontent.com&quot;,
  &quot;client_secret&quot;: &quot;d-fasdabcdabcdabceroi123knrmfs;fabc&quot;,
  &quot;refresh_token&quot;: &quot;1/asdfjlklabc;ldabc&#39;dfmk-lCkju3-yQmjr20xVZabcfkE48L&quot;,
  &quot;type&quot;: &quot;authorized_user&quot;
}
</code></pre><p>If you are a fist time <span class="caps">GCP</span> user, you may be required to enable the GCP APIs like <a href="https://console.cloud.google.com/apis/library/compute.googleapis.com/">Compute Engine <span class="caps">API</span></a> or <a href="https://console.cloud.google.com/apis/library/container.googleapis.com">Kubernetes Engine <span class="caps">API</span></a>.</p>
<p>Since <span class="caps">GCP</span> setup is ready, please update to the latest <a href="https://www.inspec.io/downloads/">InSpec</a> version. At least version 2.1.78 is required. To verify that the access works,&nbsp;run:</p>
<pre><code class="lang-bash">$ inspec detect -t gcp://

== Platform Details

Name:      gcp
Families:  cloud, api
Release:   google-cloud-v
</code></pre>
<h2 id="create-a-new-gcp-profile">Create a new <span class="caps">GCP</span>&nbsp;profile</h2>
<p>To create a new <span class="caps">GCP</span> profile, use <code>inspec init profile</code> command:</p>
<pre><code class="lang-bash">$ inspec init profile gcp-example-profile
Create new profile at /Users/chris-rock/gcp-example-profile
 * Create directory libraries
 * Create file README.md
 * Create directory controls
 * Create file controls/example.rb
 * Create file inspec.yml
 * Create file libraries/.gitkeep
$ <span class="built_in">cd</span> gcp-example-profile
$ cat inspec.yml
name: gcp-example-profile
title: InSpec Profile
maintainer: The Authors
copyright: The Authors
copyright_email: you@example.com
license: Apache-2.0
summary: An InSpec Compliance Profile
version: 0.1.0
</code></pre>
<p>InSpec creates the profile structure that looks as&nbsp;following:</p>
<pre><code>$ tree .
.
├── README.md
├── controls
│   └── example.rb
├── inspec.yml
└── libraries

2 directories, 3 files
</code></pre><p>The <code>inspec.yml</code> contains the profile metadata, <code>example.rb</code> includes the InSpec tests. Now, we adapt the <code>inspec.yml</code> to load the InSpec resource pack for Google Cloud Platform and tell InSpec that the profile is intended for&nbsp;<span class="caps">GCP</span>.</p>
<pre><code>name: gcp-example-profile
...
depends:
  - name: gcp-resources
    url: https://github.com/inspec/inspec-gcp/archive/master.tar.gz
supports:
  - platform: gcp
</code></pre><p>Now, we edit the <code>example.rb</code> verify that our <span class="caps">GCP</span> project exists via the <code>google_project</code> InSpec&nbsp;resource:</p>
<pre><code>title &#39;sample gcp test section&#39;

PROJECT_NUMBER = attribute(&#39;project_number&#39;, description: &#39;gcp project number&#39;)

control &#39;gcp-1&#39; do
  impact 0.7
  title &#39;Check development project&#39;
  describe google_project(project: PROJECT_NUMBER) do
    it { should exist }
    its(&#39;name&#39;) { should eq &#39;inspec-gcp&#39; }
    its(&#39;project_number&#39;) { should cmp PROJECT_NUMBER }
    its(&#39;lifecycle_state&#39;) { should eq &#39;ACTIVE&#39; }
  end
end
</code></pre><p>We also use InSpec <a href="https://www.inspec.io/docs/reference/profiles/#profile-attributes">attributes</a> to make the profile more flexible. Just create an <code>attributes.yml</code> that includes the <code>project_number</code> value</p>
<pre><code class="lang-yaml"><span class="attr">project_number:</span> <span class="number">41681219238</span>
</code></pre>
<p>Now, run the profile with&nbsp;InSpec:</p>
<pre><code class="lang-bash">inspec <span class="built_in">exec</span> . -t gcp:// --attrs attributes.yml

Profile: InSpec Profile (gcp-example-profile)
Version: 0.1.0
Target:  gcp://764086051850-6qr4p6gpi6hn506pt8ejuq83di341hur.apps.googleusercontent.com

  ✔  gcp-1: Check development project
     ✔  Project  should exist
     ✔  Project  name should eq <span class="string">"inspec-gcp"</span>
     ✔  Project  project_number should cmp == 41681219238
     ✔  Project  lifecycle_state should eq <span class="string">"<span class="caps">ACTIVE</span>"</span>


Profile: Google Cloud Platform Resource Pack (inspec-gcp)
Version: 0.2.0
Target:  gcp://764086051850-6qr4p6gpi6hn506pt8ejuq83di341hur.apps.googleusercontent.com

     No tests executed.

Profile Summary: 1 successful control, 0 control failures, 0 controls skipped
Test Summary: 4 successful, 0 failures, 0 skipped
</code></pre>
<p>As the next step, we add a test to verify an google storage bucket by using the <code>google_storage_bucket</code> resource:</p>
<pre><code>BUCKET = attribute(&#39;storage_bucket&#39;, description: &#39;gcp storage bucket identifier&#39;)

control &#39;gcp-3&#39; do
  impact 0.3
  title &#39;Check that the storage bucket was created&#39;
  describe google_storage_bucket(name: BUCKET) do
    it { should exist }
    its(&#39;storage_class&#39;) { should eq &#39;STANDARD&#39; }
    its(&#39;location&#39;) { should eq &#39;EUROPE-WEST2&#39; }
  end
end
</code></pre><p>Now, just update the <code>attributes.yml</code>:</p>
<pre><code>project_number: 41681219238
storage_bucket: gcp-inspec-storage-bucket-rgjqbngjzyeofzh
</code></pre><p>and run the profile with InSpec&nbsp;again:</p>
<pre><code class="lang-bash">inspec <span class="built_in">exec</span> . -t gcp:// --attrs attributes.yml

Profile: InSpec Profile (gcp-example-profile)
Version: 0.1.0
Target:  gcp://764086051850-6qr4p6gpi6hn506pt8ejuq83di341hur.apps.googleusercontent.com

  ✔  gcp-1: Check development project
     ✔  Project  should exist
     ✔  Project  name should eq <span class="string">"inspec-gcp"</span>
     ✔  Project  project_number should cmp == 41681219238
     ✔  Project  lifecycle_state should eq <span class="string">"<span class="caps">ACTIVE</span>"</span>
  ✔  gcp-3: Check that the storage bucket was created
     ✔  Bucket gcp-inspec-storage-bucket-rgjqbngjzyeofzh should exist
     ✔  Bucket gcp-inspec-storage-bucket-rgjqbngjzyeofzh storage_class should eq <span class="string">"<span class="caps">STANDARD</span>"</span>
     ✔  Bucket gcp-inspec-storage-bucket-rgjqbngjzyeofzh location should eq <span class="string">"<span class="caps">EUROPE</span>-WEST2"</span>


Profile: Google Cloud Platform Resource Pack (inspec-gcp)
Version: 0.2.0
Target:  gcp://764086051850-6qr4p6gpi6hn506pt8ejuq83di341hur.apps.googleusercontent.com

     No tests executed.

Profile Summary: 2 successful controls, 0 control failures, 0 controls skipped
Test Summary: 7 successful, 0 failures, 0 skipped
</code></pre>
<p>As the final step, we verify a <span class="caps">GCP</span> instance via the <code>google_compute_instance</code> InSpec&nbsp;resource: </p>
<pre><code>
INSTANCE_NAME = attribute(&#39;instance_name&#39;, description: &#39;gcp instance identifier&#39;)
ZONE = attribute(&#39;instance_zone&#39;, description: &#39;instance zone&#39;)

control &#39;gcp-3&#39; do
  impact 0.5
  title &#39;Check the GCP instance&#39;
  describe google_compute_instance(project: PROJECT_NUMBER, zone: ZONE, name: INSTANCE_NAME) do
    it { should exist }
    its(&#39;name&#39;) { should eq &#39;gcp-inspec-int-linux-vm&#39; }
    its(&#39;machine_type&#39;) { should eq &#39;f1-micro&#39; }
    its(&#39;cpu_platform&#39;) { should match &#39;Intel&#39; }
    its(&#39;status&#39;) { should eq &#39;RUNNING&#39; }
  end
end
</code></pre><p>Since we use two additional attributes, we update the <code>attributes.yml</code> accordingly:</p>
<pre><code>project_number: 41681219238
storage_bucket: gcp-inspec-storage-bucket-rgjqbngjzyeofzh
instance_zone: europe-west2-a
instance_name: gcp-inspec-int-linux-vm2
</code></pre><p>Let’s run the profile with InSpec&nbsp;again:</p>
<pre><code class="lang-bash">archlinux:..gcp-example-profile ±&gt; inspec <span class="built_in">exec</span> . -t gcp:// --attrs attributes.yml

Profile: InSpec Profile (gcp-example-profile)
Version: 0.1.0
Target:  gcp://764086051850-6qr4p6gpi6hn506pt8ejuq83di341hur.apps.googleusercontent.com

  ✔  gcp-1: Check development project
     ✔  Project  should exist
     ✔  Project  name should eq <span class="string">"inspec-gcp"</span>
     ✔  Project  project_number should cmp == 41681219238
     ✔  Project  lifecycle_state should eq <span class="string">"<span class="caps">ACTIVE</span>"</span>
  ✔  gcp-2: Check that the storage bucket was created
     ✔  Bucket gcp-inspec-storage-bucket-rgjqbngjzyeofzh should exist
     ✔  Bucket gcp-inspec-storage-bucket-rgjqbngjzyeofzh storage_class should eq <span class="string">"<span class="caps">STANDARD</span>"</span>
     ✔  Bucket gcp-inspec-storage-bucket-rgjqbngjzyeofzh location should eq <span class="string">"<span class="caps">EUROPE</span>-WEST2"</span>
  ✔  gcp-3: Check the <span class="caps">GCP</span> instance
     ✔  Instance gcp-inspec-int-linux-vm should exist
     ✔  Instance gcp-inspec-int-linux-vm name should eq <span class="string">"gcp-inspec-int-linux-vm"</span>
     ✔  Instance gcp-inspec-int-linux-vm cpu_platform should match <span class="string">"Intel"</span>
     ✔  Instance gcp-inspec-int-linux-vm status should eq <span class="string">"<span class="caps">RUNNING</span>"</span>


Profile: Google Cloud Platform Resource Pack (inspec-gcp)
Version: 0.2.0
Target:  gcp://764086051850-6qr4p6gpi6hn506pt8ejuq83di341hur.apps.googleusercontent.com

     No tests executed.

Profile Summary: 3 successful controls, 0 control failures, 0 controls skipped
Test Summary: 11 successful, 0 failures, 0 skipped
</code></pre>
<h2 id="summary">Summary</h2>
<p>In just a few minutes, we created a few tests that verified some aspects of our <span class="caps">GCP</span> setup. This example profile is available at <a href="https://github.com/chris-rock/inspec-verify-provision">Github</a> and should give you a good start into InSpec <span class="caps">GCP</span>. The InSpec GCP resource pack already ships with many <a href="https://github.com/inspec/inspec-gcp/tree/master/libraries">resources</a>:</p>
<ul>
<li><code>google_compute_address</code></li>
<li><code>google_compute_firewall</code></li>
<li><code>google_compute_image</code></li>
<li><code>google_compute_instance</code></li>
<li><code>google_compute_instance_group</code></li>
<li><code>google_container_cluster</code></li>
<li><code>google_container_node_pool</code></li>
<li><code>google_project.rb</code></li>
<li><code>google_project_iam_custom_role</code></li>
<li><code>google_service_account</code></li>
<li><code>google_storage_bucket</code></li>
</ul>
<p>We are always looking for more contributions and feedback for the InSpec resources. Please try out the new <span class="caps">GCP</span> resources and help us to make them better <a href="https://github.com/inspec/inspec-gcp/issues/new">questions or ideas</a>.</p>
<p>I am looking for your&nbsp;feedback!</p>
<ul>
<li>Chris </li>
</ul>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="social center">
          <div class="network"><a href="javascript:window.location=%22http://news.ycombinator.com/submitlink?u=%22+encodeURIComponent(document.location)+%22&amp;amp;t=%22+encodeURIComponent(document.title)" class="hn-link">Discuss on Hacker News</a></div>
          <div class="network twitter"><a https://twitter.com/share data-via="chri_hartmann" data-count="none" class="twitter-share-button">Tweet</a></div>
        </div>
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about">
        </section>
        <section class="copy">
          <p>&copy; 2018 Christoph Hartmann &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>