<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="google-site-verification" content="iplyfI0Y6pOe8NsNYwwrKe-QfSYamSeEhQiDFh93NiU">
    <title>Using meta-profiles with Chef Compliance - chris-rock
    </title>
    <link rel="alternate" href="http://lollyrock.com/feed.xml" type="application/rss+xml" title="fun &amp; sun">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50992958-1', 'lollyrock.com');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript">
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
      
    </script>
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Using meta-profiles with Chef Compliance</h1>
        <p class="author">Written by <span class="author"><a href="mailto:chris@lollyrock.com">Christoph Hartmann</a></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>This article demonstrates InSpec’s meta profile functionality in combination with Chef Compliance. This feature enables you to write profile overlays and to reuse controls from existing profiles. This is a great way to manage deviations of out-of-the-box profiles shipped with Chef&nbsp;Compliance.</p>
<h2 id="meta-profiles">Meta&nbsp;Profiles</h2>
<p>A meta profile is an overlay or a collection of multiple profiles. Examples&nbsp;are:</p>
<ul>
<li>a deviation from <span class="caps">CIS</span>&nbsp;benchmarks</li>
<li>collection of all <span class="caps">CIS</span> profiles that apply to your infrastructure (eg. a company-wide&nbsp;profile)</li>
</ul>
<p>The structure of a meta profile (e.g. <a href="https://github.com/chris-rock/acme-inspec-profile">Acme InSpec profile</a>) is identical to any other InSpec&nbsp;profile:</p>
<pre><code>tree acme-inspec-profile
acme-inspec-profile
├── LICENSE
├── README.md
├── controls
│   ├── hardening.rb
│   ├── patch.rb
│   └── ssl.rb
└── inspec.yml
</code></pre><p>InSpec <code>dependencies</code> are defined in <code>inspec.yml</code> via <code>depends</code>:</p>
<pre><code>$ cat acme-inspec-profile/inspec.yml
name: acme-inspec-profile
title: Meta profile for Acme Inc
maintainer: Christoph Hartmann
copyright: Christoph Hartmann
copyright_email: chris@lollyrock.com
license: Apache 2.0
summary: This profile collects all compliance and security related requirements for Acme Inc.
version: 0.1.0
depends:
  - name: linux-patch-benchmark
    git: https://github.com/dev-sec/linux-patch-benchmark.git
  - name: windows-patch-benchmark
    git: https://github.com/dev-sec/windows-patch-benchmark.git
  - name: os-hardening
    git: https://github.com/dev-sec/tests-os-hardening.git
  - name: ssh-hardening
    git: https://github.com/dev-sec/tests-ssh-hardening.git
  - name: ssl-benchmark
    git: https://github.com/dev-sec/ssl-benchmark.git
</code></pre><p>In addition to <code>git</code> dependencies, InSpec supports <code>supermarket</code>, <code>url</code> and <code>compliance</code> dependencies as profile locations as&nbsp;well:</p>
<pre><code>depends:
  # defaults to supermarket
  - name: hardening/ssh-hardening  
  # remote tar or zip file
  - name: os-hardening
    url: https://github.com/dev-sec/tests-os-hardening/archive/master.zip
  # git
  - git: https://github.com/dev-sec/ssl-benchmark.git
  - name: windows-patch-benchmark
    git: https://github.com/chris-rock/windows-patch-benchmark.git
  # Chef Compliance / Chef Automate
  - name: linux
    compliance: base/linux
</code></pre><p>Once you depend on another profile, you can leverage all its controls in your meta profile. Additionally all custom InSpec resources are available as well, in case you want to define new&nbsp;controls.</p>
<pre><code>$ cat acme-inspec-profile/controls/hardening.rb
# encoding: utf-8
#
# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# author: Christoph Hartmann
# author: Dominik Richter

# ensure linux servers are hardenend
include_controls &#39;os-hardening&#39;
include_controls &#39;ssh-hardening&#39;
</code></pre><p>InSpec provides <code>include_controls</code> and <code>require_controls</code> keywords to load controls from inherited profiles. By default, no controls are executed after you defined its dependency in <code>inspec.yml</code>. The parameter for <code>include_controls</code> eg. <code>os-hardening</code> matches the name in <code>inspec.yml</code>. In that specific case, we just import all controls from our dependency. Further documentation about this behavior   available at <a href="http://inspec.io/docs/reference/profiles/">InSpec Docs</a>. The dependency management functionality is specified in <a href="https://github.com/chef/inspec/issues/888"><span class="caps">RFC</span>&nbsp;Dependencies</a></p>
<h2 id="vendoring">Vendoring</h2>
<p>While InSpec allows runtime resolution of dependencies, customers want to ensure safety for their production environment. Some challenges I have seen very&nbsp;often:</p>
<ul>
<li>no internet is available in air-gapped&nbsp;environments</li>
<li>new profile updates need to be tested before they are used in&nbsp;production</li>
<li>integration in <span class="caps">CI</span>/CD&nbsp;pipelines</li>
</ul>
<p>In order to help with those challenges, the InSpec team decided to establish a vendoring mechanism for profiles. This process is defined in <a href="https://github.com/chef/inspec/issues/1283">Vendor dependent profiles in archive</a> and is composed of two&nbsp;steps:</p>
<ul>
<li>resolve all dependencies and their&nbsp;versions</li>
<li>download all dependencies into <code>vendor</code> directory</li>
</ul>
<p>Once those steps are finalized, an InSpec profile can be executed standalone without any internet connection available during runtime. Chef Compliance and Chef Automate prefer that approach over runtime profile&nbsp;resolution.</p>
<p>The lockfile <code>inspec.lock</code> looks similar to <code>inspec.yml</code>, but describes all version&nbsp;constraints.</p>
<pre><code>cat acme-inspec-profile/inspec.lock
---
lockfile_version: 1
depends:
- name: linux-patch-benchmark
  resolved_source:
    git: https://github.com/dev-sec/linux-patch-benchmark.git
    ref: d53030317b711f36fa2fde9e18170ce6b4eaacf2
  version_constraints: &quot;&gt;= 0&quot;
- name: windows-patch-benchmark
  resolved_source:
    git: https://github.com/dev-sec/windows-patch-benchmark.git
    ref: c183d08eb25638e7f5eac97e521640ea314c8e3d
  version_constraints: &quot;&gt;= 0&quot;
- name: os-hardening
  resolved_source:
    git: https://github.com/dev-sec/tests-os-hardening.git
    ref: da3a1b6ce8a845d6818152a824e123c2445c355f
  version_constraints: &quot;&gt;= 0&quot;
- name: ssh-hardening
  resolved_source:
    git: https://github.com/dev-sec/tests-ssh-hardening.git
    ref: 75754b9b3fe45c601f0fa0036b01c61c8b8e26d9
  version_constraints: &quot;&gt;= 0&quot;
- name: ssl-benchmark
  resolved_source:
    git: https://github.com/dev-sec/ssl-benchmark.git
    ref: e17486c864434c818f96ca13edd2c5a420100a45
  version_constraints: &quot;&gt;= 0&quot;
</code></pre><p>All dependencies are downloaded and stored in <code>vendor</code> directory.</p>
<pre><code>tree acme-inspec-profile
acme-inspec-profile
├── LICENSE
├── README.md
├── controls
│   ├── hardening.rb
│   ├── patch.rb
│   └── ssl.rb
├── inspec.lock
├── inspec.yml
└── vendor
    ├── 75754b9b3fe45c601f0fa0036b01c61c8b8e26d9
    │   ├── CHANGELOG.md
    │   ├── Gemfile
    │   ├── README.md
    │   ├── Rakefile
    │   ├── controls
    │   │   ├── ssh_spec.rb
    │   │   └── sshd_spec.rb
    │   ├── inspec.yml
    │   └── libraries
    │       └── ssh_crypto.rb
    ├── c183d08eb25638e7f5eac97e521640ea314c8e3d
    │   ├── CONTRIBUTING.md
    │   ├── ChefCompliance.png
    │   ├── InSpec+Update.png
    │   ├── LICENSE
    │   ├── README.md
    │   ├── Windows+Update.png
    │   ├── controls
    │   │   └── patches.rb
    │   ├── inspec.yml
    │   └── libraries
    │       └── windows_updates.rb
    ├── d53030317b711f36fa2fde9e18170ce6b4eaacf2
    │   ├── CentOS+Patch.png
    │   ├── Gemfile
    │   ├── LICENSE
    │   ├── README.md
    │   ├── Rakefile
    │   ├── controls
    │   │   └── patches.rb
    │   ├── inspec.yml
    │   └── libraries
    │       └── linux_updates.rb
    ├── da3a1b6ce8a845d6818152a824e123c2445c355f
    │   ├── CHANGELOG.md
    │   ├── Gemfile
    │   ├── README.md
    │   ├── Rakefile
    │   ├── controls
    │   │   ├── os_spec.rb
    │   │   ├── package_spec.rb
    │   │   └── sysctl_spec.rb
    │   └── inspec.yml
    └── e17486c864434c818f96ca13edd2c5a420100a45
        ├── README.md
        ├── controls
        │   └── ssl_test.rb
        └── inspec.yml

15 directories, 43 files
</code></pre><h2 id="execute-a-meta-profile-with-chef-compliance">Execute a meta profile with Chef&nbsp;Compliance</h2>
<p>In order to run meta profiles we need at least <a href="https://discourse.chef.io/t/chef-compliance-1-7-3-inspec-1-7-1/9985">Chef Compliance 1.7.3</a>. Next, just clone the  <a href="https://github.com/chris-rock/acme-inspec-profile">Acme InSpec profile</a> via <code>git clone https://github.com/chris-rock/acme-inspec-profile</code>. We have two options to upload the profile to Chef&nbsp;Compliance:</p>
<ul>
<li>Upload via InSpec&nbsp;<span class="caps">CLI</span></li>
<li>Upload of archive via Chef Compliance Web&nbsp;<span class="caps">UI</span></li>
</ul>
<p>The first is the easiest since everything is done for you with one&nbsp;command.</p>
<h3 id="upload-via-inspec-cli">Upload via InSpec&nbsp;<span class="caps">CLI</span></h3>
<p>First, you need to login to Chef Compliance. You find your login token in Chef Compliance via the about&nbsp;dialog.</p>
<p><center><img src="/articles/chef-compliance-meta-profiles/cc-token-fs8.png" alt="Copy the token from Chef Compliance" title="Access Token in Chef Compliance" width="700px"></center></p>

<p>Use that token to login via InSpec&nbsp;<span class="caps">CLI</span>:</p>
<pre><code>$ inspec compliance login https://compliance.test --insecure --user=&#39;admin&#39; --token=&#39;eyJh....Jlqg&#39;

API access token stored

$ git clone https://github.com/chris-rock/acme-inspec-profile
Cloning into &#39;acme-inspec-profile&#39;...
remote: Counting objects: 12, done.
remote: Total 12 (delta 0), reused 0 (delta 0), pack-reused 12
Unpacking objects: 100% (12/12), done.
Checking connectivity... done.
</code></pre><p>Once you are logged in, you use the <code>compliance upload</code> command to package and upload the <code>acme-inspec-profile</code> profile for Chef&nbsp;Compliance.</p>
<pre><code>$ inspec compliance upload acme-inspec-profile            
Vendor dependencies of acme-inspec-profile into acme-inspec-profile/vendor
I, [2016-12-06T10:24:43.899931 #90853]  INFO -- : Checking profile in acme-inspec-profile
I, [2016-12-06T10:24:43.900029 #90853]  INFO -- : Metadata OK.
`command(ssh).exist?` is not suported on your OS:
I, [2016-12-06T10:24:44.070233 #90853]  INFO -- : Found 120 controls.
W, [2016-12-06T10:24:44.070519 #90853]  WARN -- : Control verify-kb has no description
W, [2016-12-06T10:24:44.070555 #90853]  WARN -- : Control important-count has no description
W, [2016-12-06T10:24:44.070571 #90853]  WARN -- : Control important-patches has no description
W, [2016-12-06T10:24:44.070581 #90853]  WARN -- : Control important-patches has no tests defined
W, [2016-12-06T10:24:44.070591 #90853]  WARN -- : Control optional-count has no description
W, [2016-12-06T10:24:44.070601 #90853]  WARN -- : Control optional-patches has no description
W, [2016-12-06T10:24:44.070610 #90853]  WARN -- : Control optional-patches has no tests defined
W, [2016-12-06T10:24:44.070619 #90853]  WARN -- : Control verify-patches has no description
W, [2016-12-06T10:24:44.070629 #90853]  WARN -- : Control patches has no description
W, [2016-12-06T10:24:44.070638 #90853]  WARN -- : Control patches has no tests defined
Profile is valid
Generate temporary profile archive at /var/folders/jy/2bnrfb4s36jbjtzllvhhyqhw0000gn/T/acme-inspec-profile20161206-90853-kzpo1p.tar.gz
I, [2016-12-06T10:24:44.088457 #90853]  INFO -- : Generate archive /var/folders/jy/2bnrfb4s36jbjtzllvhhyqhw0000gn/T/acme-inspec-profile20161206-90853-kzpo1p.tar.gz.
I, [2016-12-06T10:24:44.194607 #90853]  INFO -- : Finished archive generation.
Start upload to admin/acme-inspec-profile
Uploading to Chef Compliance
Successfully uploaded profile
</code></pre><p>The profile is available in Chef Compliance&nbsp;now:</p>
<p><center><img src="/articles/chef-compliance-meta-profiles/cc-meta-profile-fs8.png" alt="The meta profile is available in Chef Compliance" title="Meta profile in Chef Compliance" width="700px"></center></p>

<h3 id="upload-of-archive-via-chef-compliance-web-ui">Upload of archive via Chef Compliance Web&nbsp;<span class="caps">UI</span></h3>
<p>In cases, where you cannot upload the profile via <span class="caps">CLI</span>, you have to archive the profile manually. At first you trigger the vendoring process via <code>inspec vendor</code></p>
<pre><code>$ inspec vendor acme-inspec-profile
Vendor dependencies of acme-inspec-profile into acme-inspec-profile/vendor
</code></pre><p>Once the vendoring process is done, the <code>vendor</code> directory and the <code>inspec.lock</code> are placed in the <code>acme-inspec-profile</code> directory. Now, run <code>inspec archive</code> to generate a&nbsp;package.</p>
<pre><code>$ inspec archive acme-inspec-profile
I, [2016-12-06T10:32:59.234327 #93241]  INFO -- : Checking profile in acme-inspec-profile
I, [2016-12-06T10:32:59.234422 #93241]  INFO -- : Metadata OK.
`command(ssh).exist?` is not suported on your OS:
I, [2016-12-06T10:32:59.376949 #93241]  INFO -- : Found 126 controls.
W, [2016-12-06T10:32:59.377156 #93241]  WARN -- : Control verify-kb has no description
W, [2016-12-06T10:32:59.377181 #93241]  WARN -- : Control important-count has no description
W, [2016-12-06T10:32:59.377199 #93241]  WARN -- : Control important-patches has no description
W, [2016-12-06T10:32:59.377214 #93241]  WARN -- : Control important-patches has no tests defined
W, [2016-12-06T10:32:59.377225 #93241]  WARN -- : Control optional-count has no description
W, [2016-12-06T10:32:59.377235 #93241]  WARN -- : Control optional-patches has no description
W, [2016-12-06T10:32:59.377243 #93241]  WARN -- : Control optional-patches has no tests defined
W, [2016-12-06T10:32:59.377253 #93241]  WARN -- : Control verify-patches has no description
W, [2016-12-06T10:32:59.377262 #93241]  WARN -- : Control patches has no description
W, [2016-12-06T10:32:59.377277 #93241]  WARN -- : Control patches has no tests defined
W, [2016-12-06T10:32:59.377294 #93241]  WARN -- : Control tls1.2 has no description
W, [2016-12-06T10:32:59.377329 #93241]  WARN -- : Control tls1.2 has no tests defined
W, [2016-12-06T10:32:59.377339 #93241]  WARN -- : Control ssl2 has no description
W, [2016-12-06T10:32:59.377392 #93241]  WARN -- : Control ssl2 has no tests defined
W, [2016-12-06T10:32:59.377408 #93241]  WARN -- : Control ssl3 has no description
W, [2016-12-06T10:32:59.377419 #93241]  WARN -- : Control ssl3 has no tests defined
W, [2016-12-06T10:32:59.377429 #93241]  WARN -- : Control tls1.0 has no description
W, [2016-12-06T10:32:59.377441 #93241]  WARN -- : Control tls1.0 has no tests defined
W, [2016-12-06T10:32:59.377480 #93241]  WARN -- : Control tls1.1 has no description
W, [2016-12-06T10:32:59.377536 #93241]  WARN -- : Control tls1.1 has no tests defined
W, [2016-12-06T10:32:59.377567 #93241]  WARN -- : Control rc4 has no description
W, [2016-12-06T10:32:59.377586 #93241]  WARN -- : Control rc4 has no tests defined
I, [2016-12-06T10:32:59.378081 #93241]  INFO -- : Generate archive /Users/chartmann/Development/compliance/inspec/acme-inspec-profile.tar.gz.
I, [2016-12-06T10:32:59.486476 #93241]  INFO -- : Finished archive generation.
</code></pre><p><center><img src="/articles/chef-compliance-meta-profiles/cc-manual-upload-fs8.png" alt="Upload the profile to Chef Compliance" title="Profile Upload Chef Compliance" width="700px"></center></p>

<h3 id="scan-a-node">Scan a&nbsp;node</h3>
<p>Voilà, the profile is available in Chef&nbsp;Compliance:</p>
<p><center><img src="/articles/chef-compliance-meta-profiles/cc-profile-fs8.png" alt="Browse the profile in Chef Compliance" title="View profile details in Chef Compliance" width="700px"></center></p>

<p>The profile can be selected for remote scans via the Chef Compliance&nbsp;dashboard:</p>
<p><center><img src="/articles/chef-compliance-meta-profiles/cc-scan-fs8.png" alt="Trigger a scan in Chef Compliance" title="Trigger scan in Chef Compliance" width="700px"></center></p>

<p>Once the scan is done, you’ll see a report including controls from all dependent&nbsp;profiles:</p>
<p><center><img src="/articles/chef-compliance-meta-profiles/cc-scanresult-fs8.png" alt="The meta profile is available in Chef Compliance" title="Meta profile in Chef Compliance" width="700px"></center></p>

<h2 id="summary">Summary</h2>
<p>We’ve seen how meta profiles are defined and executed. The new meta profile mechanism makes it easy for users to define complex scenarios and manage profile deviations in an easy and understandable way. Inline with the InSpec philosophy, everything is defined as <code>Compliance as Code</code>.</p>
<p>Let me know how that works for&nbsp;you!</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="social center">
          <div class="network"><a href="javascript:window.location=%22http://news.ycombinator.com/submitlink?u=%22+encodeURIComponent(document.location)+%22&amp;amp;t=%22+encodeURIComponent(document.title)" class="hn-link">Discuss on Hacker News</a></div>
          <div class="network twitter"><a https://twitter.com/share data-via="chri_hartmann" data-count="none" class="twitter-share-button">Tweet</a></div>
        </div>
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about">
        </section>
        <section class="copy">
          <p>&copy; 2017 Christoph Hartmann &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>