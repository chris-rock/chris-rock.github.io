<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="google-site-verification" content="iplyfI0Y6pOe8NsNYwwrKe-QfSYamSeEhQiDFh93NiU">
    <title>HomeKit for Fritz!Box smart home devices - chris-rock
    </title>
    <link rel="alternate" href="http://lollyrock.com/feed.xml" type="application/rss+xml" title="fun &amp; sun">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50992958-1', 'lollyrock.com');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript">
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
      
    </script>
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>HomeKit for Fritz!Box smart home devices</h1>
        <p class="author">Written by <span class="author"><a href="mailto:chris@lollyrock.com">Christoph Hartmann</a></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>Every year at Christmas, I get some time to play with new exiting stuff. This year, I decided to play with my smart home devices. And of course, some <em>intelligent</em> personal assistant needs to be part of&nbsp;it.</p>
<p>Right now, I prefer devices from <a href="https://en.avm.de/products/fritzdect/"><span class="caps">AVM</span> Fritz!</a> since their devices have a track record for long-term maintenance. They have one disadvantage though: A missing Apple HomeKit integration. Let’s fix&nbsp;that.</p>
<h2 id="goal">Goal</h2>
<p>Before I start a project, I like to set its goal: Apple Siri needs to be able to manage my devices. At the end, I want to be able to ask&nbsp;her:</p>
<ul>
<li>Siri, <em>turn on</em> the Christmas&nbsp;tree</li>
<li>Siri, <em>heat up</em> the dining room to <em>24 degrees&nbsp;celsius</em></li>
</ul>
<p><strong>Just remember</strong>: a simple wall switch or thermostat is doing the same as this relatively complex setup with smart home devices, HomeKit bridge and network setup&nbsp;:-)</p>
<p>Siri is already tightly coupled with HomeKit, therefore we just have to register all Fritz! smart home devices in HomeKit. Sounds easy,&nbsp;right? </p>
<p>I added some further&nbsp;restrictions:</p>
<ul>
<li>I want a HomeKit bridge that only manages Fritz!&nbsp;devices</li>
<li>I want a single binary running as the&nbsp;service</li>
</ul>
<h2 id="prepare-fritzbox">Prepare&nbsp;FritzBox</h2>
<p>I am not going in detail about the Fritz!Box configuration. I assume you have prepared the box and registered your smart home devices properly. I recommend creating a special <code>smarthome</code> user in your Fritz!Box who has limited access to smart home devices&nbsp;only.</p>
<p><img src="/articles/homekit-for-fritzbox/configure_fritzbox_user.png" alt="Configure smarthome user in Fritz!Box" title="Restrict access for smart home user"></p>
<p>We are going to use that user and password for the HomeKit bridge in a minute. That is&nbsp;all.</p>
<h2 id="homekit-for-fritz-box">HomeKit for&nbsp;Fritz!Box</h2>
<p>I’ve developed a <a href="https://github.com/chris-rock/homekit-fritz">HomeKit bridge</a> in Go that is using the <a href="https://avm.de/fileadmin/user_upload/Global/Service/Schnittstellen/AHA-HTTP-Interface.pdf">Fritz!Box <span class="caps">API</span></a>.</p>
<p><img src="/articles/homekit-for-fritzbox/github_project.png" alt="HomeKit bridge for Fritz!Box" title="Enables Fritz! smart devices in HomeKit"></p>
<p>The implementation is based on two excellent go&nbsp;libraries:</p>
<ul>
<li><a href="https://github.com/brutella/hc">HomeControl is an implementation of the HomeKit Accessory Protocol (<span class="caps">HAP</span>) in&nbsp;Go</a></li>
<li><a href="https://github.com/bpicode/fritzctl">fritzctl - console <span class="caps">AVM</span> FRITZ!Box&nbsp;client</a></li>
</ul>
<p>Especially, HomeControl makes it very easy to create devices and show them in Apples Home&nbsp;app.</p>
<p>The most difficult piece was the support for <a href="https://theapplepips.com/homekit-gains-easier-setup-with-nfcqr-codes-improved-latency-support-for-sprinklersfaucets-more/">Apples setup code</a>, because it is not part of Apple’s <a href="https://developer.apple.com/homekit/specification/">Non-commercial HomeKit Accessory Protocol Specification</a>. </p>
<p><img src="/articles/homekit-for-fritzbox/homekit_setup_code.png" alt="HomeKit setup codes"></p>
<p>Thankfully, the excellent <a href="https://github.com/nfarina/homebridge">homebridge
</a> project had already support for it. A couple of PRs to other projects later, the basic setup was up and running! Let’s try&nbsp;it.</p>
<h2 id="get-it-running">Get it&nbsp;running</h2>
<p>You will find pre-compiled binaries on <a href="https://github.com/chris-rock/homekit-fritz/releases">Github</a>, which makes the installation way&nbsp;easier, </p>
<pre><code># Download and extract the hkfritz binary
$ mkdir hkfritz
$ curl -L https://github.com/chris-rock/homekit-fritz/releases/download/0.1.5/homekit-fritz_0.1.5_darwin_amd64.tar.gz | tar -xvzf -

# Configure the service
$ ./hkfritz configure
</code></pre><p>This will start the setup. You need to enter the Fritz!Box user and the password that we created&nbsp;above.</p>
<p><img src="/articles/homekit-for-fritzbox/homekit_bridge_setup.png" alt="Setup HomeKit bridge for Fritz!Box" title="Run the setup command for the HomeKit bridge"></p>
<p>Now, we are ready to start the&nbsp;bridge:</p>
<pre><code># start the HomeKit bridge
$ ./hkfritz serve
</code></pre><p><img src="/articles/homekit-for-fritzbox/mac_serve.png" alt="Run bridge on macOS"></p>
<p>That is all we need. Next step will be to configure Apple’s Home&nbsp;app.</p>
<h2 id="run-on-raspberry-pi">Run on Raspberry&nbsp;Pi</h2>
<p>Instead of running the bridge on your desktop system, you can easily run this on a headless server like the Raspberry <span class="caps">PI</span>. Just install and run <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a> and follow the <a href="https://www.raspberrypi.org/documentation/installation/installing-images/README.md">installation guide</a>. Next, prepare <a href="https://www.raspberrypi.org/documentation/remote-access/ssh/"><span class="caps">SSH</span> access</a> to your Raspi. I had to re-setup the openssh server via <code>sudo rm /etc/ssh/ssh_host_* &amp;&amp; sudo dpkg-reconfigure openssh-server</code>. Now we are ready to run our bridge. Lets download our bridge. Be aware that Raspberry Pi is running on <span class="caps">ARM</span> instead on Intel/AMD. Therefore, we need to download the arm6&nbsp;binary. </p>
<pre><code>mkdir hkfritz
curl -L https://github.com/chris-rock/homekit-fritz/releases/download/0.1.5/homekit-fritz_0.1.5_linux_armv6.tar.gz | tar -xvzf -
</code></pre><p>The next steps are the same as above, we configure the bridge and start the&nbsp;service.</p>
<p><img src="/articles/homekit-for-fritzbox/raspi_configure.png" alt="Configure bridge on Raspberry Pi">
<img src="/articles/homekit-for-fritzbox/raspi_serve.png" alt="Run bridge on Raspberry Pi"></p>
<h2 id="configure-home-app">Configure Home&nbsp;app</h2>
<p>The configuration of the Home app is straight forward. Just setup your rooms first. Once you’ve done this, push the <em>Add Accessory</em> button and point your iPhone to the <span class="caps">QR</span> on your terminal. For this to work, your iPhone needs to be on the same network as your Fritz!Box and HomeKit&nbsp;bridge.</p>
<p><img style="float: left;" src="homekit_setup_01.png">
<img style="float: left;" src="homekit_setup_02.png"></p>
<div style="clear: both;padding-bottom:20px;"></div>

<p>During the setup, you are guided through all smart home devices registered with your Fritz!Box. If you want to run actions on rooms, you should add the proper room to the&nbsp;device.</p>
<p><img style="float: left;" src="homekit_setup_03.png">
<img style="float: left;" src="homekit_setup_04.png"></p>
<div style="clear: both;padding-bottom:20px;"></div>

<p>We are ready to push buttons within your Home app to manipulate your smart home&nbsp;devices.</p>
<h2 id="talk-to-siri">Talk to&nbsp;Siri</h2>
<p>Since everything is configured properly, let’s try&nbsp;Siri:</p>
<ul>
<li>Siri, <em>heat up</em> the dining room to <em>24 degrees&nbsp;celsius</em></li>
</ul>
<p><img style="float: left;" src="siri_01.png">
<img style="float: left;" src="siri_02.jpg"></p>
<div style="clear: both;padding-bottom:20px;"></div>

<ul>
<li>Siri, <em>turn on</em> the Christmas&nbsp;tree</li>
</ul>
<p><img style="float: left;" src="siri_03.png">
<img style="float: left;" src="siri_04.jpg"></p>
<div style="clear: both;padding-bottom:20px;"></div>

<h2 id="conclusion">Conclusion</h2>
<p>This was a fun project. It included a bunch of technology to get everything running. Go is the perfect companion for arm development. The cross-compilation features made the development very straight forward. I explicitly tried to run this project on a Raspberry Pi 1 and the bridge has not behaved slower than running it on a Mac. Hopefully, <span class="caps">AVM</span> is shipping with HomeKit capabilities by next year, until then, my Raspi has work to do&nbsp;:-)</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="social center">
          <div class="network"><a href="javascript:window.location=%22http://news.ycombinator.com/submitlink?u=%22+encodeURIComponent(document.location)+%22&amp;amp;t=%22+encodeURIComponent(document.title)" class="hn-link">Discuss on Hacker News</a></div>
          <div class="network twitter"><a https://twitter.com/share data-via="chri_hartmann" data-count="none" class="twitter-share-button">Tweet</a></div>
        </div>
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about">
        </section>
        <section class="copy">
          <p>&copy; 2017 Christoph Hartmann &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>