<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="google-site-verification" content="iplyfI0Y6pOe8NsNYwwrKe-QfSYamSeEhQiDFh93NiU">
    <title>InSpec for provisioning testing: Verify Terraform setups with InSpec - chris-rock
    </title>
    <link rel="alternate" href="http://lollyrock.com/feed.xml" type="application/rss+xml" title="fun &amp; sun">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50992958-1', 'lollyrock.com');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript">
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
      
    </script>
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>InSpec for provisioning testing: Verify Terraform setups with InSpec</h1>
        <p class="author">Written by <span class="author"><a href="mailto:chris@lollyrock.com">Christoph Hartmann</a></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>We want to bring the same testing experience known from configuration management to provisioning and InSpec 2.0 is making it happen. We are going to explain why it is important and how you can use Terraform with&nbsp;InSpec.</p>
<h2 id="overview">Overview</h2>
<p>Until today, it was not easy to verify that all your provisioned infrastructure is working properly. While InSpec 1.x is great at covering your operating system configuration and runtime, it was lacking native support for cloud environments e.g. to verify security groups or <span class="caps">IAM</span> permissions. A few days ago, <a href="https://blog.chef.io/2018/02/20/announcing-inspec-2-0/">InSpec 2.0</a> has been released and it adds support for cloud resources. Equipped with its new features, we are enabled to verify our infrastructure provisioned with <a href="https://www.terraform.io/">Terraform</a>, <a href="https://aws.amazon.com/cloudformation/"><span class="caps">AWS</span> CloudFormation</a> or <a href="https://azure.microsoft.com/en-us/resources/templates/">Azure Resource Manager Templates</a>.</p>
<h2 id="why-do-we-need-to-test-provisioned-infrastructures">Why do we need to test provisioned&nbsp;infrastructures</h2>
<p>When we think about infrastructure automation, most likely we think about configuration management like Ansible, Chef and Puppet. With the rise of IaaS/cloud infrastructures such as VmWare, <span class="caps">AWS</span>, Azure or GCP, we started to automate complete infrastructure stacks. Besides pure configuration management of instances, those stacks include all pieces required to run our application like dns and firewall configuration. This allows us to replicate complete environments automatically, consistently and very rapidly. By doing configuration management  over the past decade, we learned that we need to think about the development and deployment lifecycle. The same is true for those stacks. To ensure quality and reliability during rapid change, testing is required to establish trust for the&nbsp;automation:</p>
<ul>
<li><strong>safety at velocity</strong>: you can deploy changes to all parts of your infrastructure with confidence since testing is included. teams working together on a tech stack, are able to prevent changes that break your&nbsp;environment</li>
<li><strong>negative testing</strong>: ensure things that should not be in your stack e.g you may want to ensure that all your machines are not reachable by unknown ip addresses. This cannot easily be achieved with provisioning&nbsp;tools</li>
<li><strong>continuous release</strong>: automation in combination with infrastructure testing allows you to have a build pipeline that sets up testing and staging environment to ensure that your system keeps working as&nbsp;intended</li>
</ul>
<h2 id="recap-automating-compliance-the-birth-of-inspec">Recap: Automating Compliance - The birth of&nbsp;InSpec</h2>
<p>Before InSpec, <a href="http://arlimus.github.io">Dominik Richter</a> and I developed SaaS services that had to comply with German regulations. We learned the hard way how difficult it is to pass audits since the tooling was just not there. Based on our experience, we started the development of InSpec eventually. From day one, we worked with developers, operations and auditors to cover the needs for infrastructure and compliance testing. The main goal during InSpec’s inception was to bring compliance into the world of automation. We did some key design decisions very early&nbsp;on: </p>
<ul>
<li>Make test language and profiles available to all teams dealing with&nbsp;infrastructure</li>
<li>Easy to use, easy to see&nbsp;results</li>
<li>Combine a testing language with native support for test collections (aka&nbsp;profiles) </li>
<li>Built-in but optional control&nbsp;metadata</li>
<li>Run any test locally and&nbsp;remotely</li>
<li>Enable easy integration into any <span class="caps">CI</span>/CD&nbsp;pipeline</li>
</ul>
<p>Those early design decisions made InSpec very successful. We work with companies and government agencies that have the most rigid compliance requirements. They need to comply with <span class="caps">PCI</span>, HIPPA and STIGs or any combination of those. Only with InSpec, they have been successful to bring development, operations and compliance teams together by harmonized the testing language across&nbsp;teams. </p>
<p><img src="/articles/inspec-terraform/teams.png" alt="DevOps, Security and Compliance working together" title="DevOps, Security and Compliance working together"></p>
<p>In InSpec, a test&nbsp;like</p>
<pre><code>SSH supports two different protocol versions. The original 
version, SSHv1, was subject to a number of security issues. 
Please use SSHv2 instead to avoid these.
</code></pre><p>turns&nbsp;into</p>
<pre><code class="lang-ruby">describe sshd_config <span class="keyword">do</span>
  its(<span class="string">'Protocol'</span>) { should eq(<span class="string">'2'</span>) }
<span class="keyword">end</span>
</code></pre>
<p>If required, additional metadata can be&nbsp;providing:</p>
<pre><code class="lang-ruby">control <span class="string">'sshd-10'</span> <span class="keyword">do</span>
  impact <span class="number">1.0</span>
  title <span class="string">'Server: Specify protocol version 2'</span>
  desc <span class="string">"Only <span class="caps">SSH</span> protocol version 2 connections should be permitted. Version 1 of the protocol contains security vulnerabilities. Don't use legacy insecure SSHv1 connections anymore."</span>
  describe sshd_config <span class="keyword">do</span>
    its(<span class="string">'Protocol'</span>) { should eq(<span class="string">'2'</span>) }
  <span class="keyword">end</span>
<span class="keyword">end</span>
</code></pre>
<p>This is enough code to run it againt a system&nbsp;via:</p>
<pre><code class="lang-bash"><span class="comment"># run test locally</span>
inspec <span class="built_in">exec</span> test.rb

<span class="comment"># run test on remote host on <span class="caps">SSH</span></span>
inspec <span class="built_in">exec</span> test.rb -t ssh://user@hostname -i /path/to/key

<span class="comment"># run test on remote windows host on WinRM</span>
inspec <span class="built_in">exec</span> test.rb -t winrm://user@hostname --password <span class="string">'your-password'</span>

<span class="comment"># run test on docker container</span>
inspec <span class="built_in">exec</span> test.rb -t docker://container_id
</code></pre>
<p>Further information about InSpec and profiles is available on <a href="https://www.inspec.io/">inspec.io</a></p>
<h2 id="inspec-goes-beyond-machine-based-testing">InSpec goes beyond machine-based&nbsp;testing</h2>
<p>When we started the development of InSpec, the infrastructure and compliance testing space was all focused on configuration and runtime verification. By working very closely with users, we quickly realized that a shift in the industry is happening: compliance requirements shift from operating systems to their management system. The classic example for that change is a firewall configuration. In the past, we configured every firewall rules on each operating system. In IaaS setups, you setup network and security group configuration along with your instance when you deploy it but not at the operating system level. The compliance rules stay valid, but they moved to the system that manages the virtual infrastructure. Therefore we want to describe something&nbsp;like:</p>
<pre><code>describe aws_security_group(&quot;sg-12345678&quot;) do
  it { should exist }
end
</code></pre><p>As shown above, InSpec is able to execute tests locally or remotely via ssh, winrm or Docker connection.  While this is already very flexible, it does not fit our use case. It would feel strange to the user to write a test like a security group verification and run that test against an operating system. The syntax would feel right, but it is neither checking a local or remote operating system&nbsp;configuration. </p>
<p>Faced with that challenge, we stepped back from any specific coding and thought about a tool that would just focus on cloud testing. After some usability testing, we figured&nbsp;that:</p>
<ul>
<li>we would still use the same language to describe&nbsp;tests</li>
<li>we would still write a profile to share test&nbsp;collections</li>
<li>we would still need similar reporting&nbsp;capabilities</li>
</ul>
<p>The main difference would be the communication to the system that we are checking. We would want to talk to the <span class="caps">API</span> directly and it should look&nbsp;like:</p>
<pre><code># run test against aws api
inspec exec test.rb -t aws://profile
</code></pre><p>Dominik specified our thought process in what we called <a href="https://github.com/chef/inspec/issues/1661">Platform <span class="caps">RFC</span></a>. The radical shift here is that InSpec 1.0 took an operating system for granted, while InSpec 2.0 only knows platforms. Each platform has a supported <span class="caps">API</span>. In that sense, an operating system is becoming the special case. By doing all the hard work behind the scenes, we were able to extend the capabilities of InSpec without compromising on the user experience,&nbsp;since:</p>
<ul>
<li>resources know the platform they&nbsp;support</li>
<li>test executed against the wrong platform are automatically&nbsp;skipped</li>
<li>all existing profile management and reporting keeps the&nbsp;same</li>
<li>backward compatibility with InSpec&nbsp;1.0</li>
<li>we can aggregate profiles for different platforms in a meta-profile (operating system and&nbsp;<span class="caps">APIS</span>)</li>
</ul>
<p>InSpec 2.0 adds initial platform support for <span class="caps">AWS</span> and Azure. The next part of this blog post series will demonstrate how you can InSpec 2.0 in combination with&nbsp;Terraform.</p>
<p><img src="/articles/inspec-terraform/aws-infrastructure.png" alt="Environment with instances and cloud-native services" title="Environment with instances and cloud-native services"></p>
<h2 id="inspec-terraform">InSpec +&nbsp;Terraform</h2>
<p><img src="/articles/inspec-terraform/terraform_inspec_logo.png" alt="Terraform + InSpec" title="Use Terraform with InSpec"></p>
<p>The following example is based on the <a href="https://github.com/terraform-providers/terraform-provider-aws/tree/master/examples/two-tier">Basic Two-Tier <span class="caps">AWS</span> Architecture</a> example. It provides a template for running a simple two-tier architecture on <span class="caps">AWS</span>. Once Terraform created the environment, a stateless nginx server is running behind an Elastic Load Balancer on AWS. To get this example running, you just have to run <code>terraform apply</code>. We are going to extend this example to eliminate the manual testing. The extended example is available on <a href="/articles/inspec-terraform/(https://github.com/chris-rock/inspec-verify-provision">Github</a>.</p>
<p>Within the Terraform directory run <code>inspec init profile test/verify</code> to create a new empty InSpec profile. Then adapt the <code>inspec.yml</code> to reflect your use case. As a next step, we are going to add tests. For each Terraform&nbsp;resource</p>
<pre><code>resource &quot;aws_security_group&quot; &quot;default&quot; {
  name        = &quot;terraform_example&quot;
  description = &quot;Used in the terraform&quot;
  vpc_id      = &quot;${aws_vpc.default.id}&quot;

  ...
}
</code></pre><p>you can write an test that uses available <a href="https://www.inspec.io/docs/reference/resources/">InSpec&nbsp;resources</a></p>
<pre><code>describe aws_security_group(group_name: &#39;terraform_example&#39;) do
  it { should exist }
  its(&#39;group_name&#39;) { should eq &#39;terraform_example&#39; }
  its(&#39;description&#39;) { should eq &#39;Used in the terraform&#39; }
  its(&#39;vpc_id&#39;) { should eq VPC_ID }  
end
</code></pre><p>For some tests, we need data from Terraform. The best hand-over at this point is the use of <a href="https://www.terraform.io/intro/getting-started/outputs.html">terraform output</a> variables. Define the variables that you need as an output in&nbsp;Terraform:</p>
<pre><code>output &quot;vpc_id&quot; {
  value = &quot;${aws_vpc.default.id}&quot;
}
</code></pre><p>Terraform has a neat built-in feature that allows the output of the variables as json&nbsp;file.</p>
<pre><code>terraform output --json &gt; test/verify/files/terraform.json
</code></pre><p>InSpec is able to <a href="https://github.com/chef/inspec/issues/1396">load files from profiles</a> if they are located in the <code>files</code> directory&nbsp;directly:</p>
<pre><code># load data from Terraform output
content = inspec.profile.file(&quot;terraform.json&quot;)
params = JSON.parse(content)

# store vpc in variable
VPC_ID = params[&#39;vpc_id&#39;][&#39;value&#39;]

# you can use the variable in various spaces

describe aws_vpc(vpc_id: VPC_ID) do
  its(&#39;cidr_block&#39;) { should cmp &#39;10.0.0.0/16&#39; }
end

describe aws_security_group(group_name: &#39;terraform_example&#39;) do
  it { should exist }
  its(&#39;group_name&#39;) { should eq &#39;terraform_example&#39; }
  its(&#39;description&#39;) { should eq &#39;Used in the terraform&#39; }
  its(&#39;vpc_id&#39;) { should eq VPC_ID }  
end
</code></pre><p>This allows us to use any data from Terraform in InSpec. We are ready to provision the infrastructure and run InSpec checks afterwards. To see everything in&nbsp;action:</p>
<pre><code># clone repository
git clone git@github.com:chris-rock/inspec-verify-provision.git
cd inspec-verify-provision/terraform

# download the required plugins
terraform init

# run terraform to apply the changes
terraform apply -var &#39;key_name=terraform&#39; -var &#39;public_key_path=/Users/chris/.ssh/id_rsa.pub&#39;

# make terraform variables available to inspec
terraform output --json &gt; test/verify/files/terraform.json

# run the inspec profile to verify the setup
inspec exec test/verify -t aws://
</code></pre><p><img src="/articles/inspec-terraform/terraform_inspec.png" alt="InSpec report for Terraform provisioning" title="InSpec report for Terraform provisioning"></p>
<h2 id="wrap-up">Wrap-Up</h2>
<p>This post covered why provisioning testing is important and demonstrate its use with Terraform. We know that not all required resources are available yet. Please help us to extend the coverage and do not hesitate to contact me for any&nbsp;feedback.</p>
<p>Going forward we want to improve the Terraform experience by reusing the InSpec attributes for loading variables in InSpec. This will allow you to reuse the same InSpec profile in different&nbsp;contexts.</p>
<p>Follow-up posts will cover <span class="caps">AWS</span> Cloudformation and Azure Resource Manager templates in conjunction with&nbsp;InSpec.</p>
<p>I hope this was helpful. Have a happy automation&nbsp;day.</p>
<h2 id="kudos">Kudos</h2>
<p>I’d like to thank the InSpec team and all contributors to inspec-aws and inspec-azure repository for making this&nbsp;happen.</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="social center">
          <div class="network"><a href="javascript:window.location=%22http://news.ycombinator.com/submitlink?u=%22+encodeURIComponent(document.location)+%22&amp;amp;t=%22+encodeURIComponent(document.title)" class="hn-link">Discuss on Hacker News</a></div>
          <div class="network twitter"><a https://twitter.com/share data-via="chri_hartmann" data-count="none" class="twitter-share-button">Tweet</a></div>
        </div>
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about">
        </section>
        <section class="copy">
          <p>&copy; 2018 Christoph Hartmann &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>