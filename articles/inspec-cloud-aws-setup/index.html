<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="google-site-verification" content="iplyfI0Y6pOe8NsNYwwrKe-QfSYamSeEhQiDFh93NiU">
    <title>Getting started with InSpec for AWS. Testing for the cloud! - chris-rock
    </title>
    <link rel="alternate" href="http://lollyrock.com/feed.xml" type="application/rss+xml" title="fun &amp; sun">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50992958-1', 'lollyrock.com');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript">
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
      
    </script>
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Getting started with InSpec for AWS. Testing for the cloud!</h1>
        <p class="author">Written by <span class="author"><a href="mailto:chris@lollyrock.com">Christoph Hartmann</a></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>With the introduction of InSpec 2.0, we got the ability to test <span class="caps">AWS</span> environments. Within the next 5 minutes, you are ready to write InSpec tests to verify your AWS environment. Let’s&nbsp;start.</p>
<h2 id="background">Background</h2>
<p>Dominik already introduced the new concepts of <a href="https://thenewstack.io/moving-beyond-limits-infrastructure-testing-inspec-2-0/">InSpec 2.0</a>. He and I created InSpec for machine testing but abstracted InSpec’s test syntax from specific test targets. This is very helpful, since the same language can be used to describe tests for machine and api&nbsp;testing. </p>
<p>A simple test for an operating system package can be written&nbsp;like:</p>
<pre><code class="lang-ruby"><span class="comment"># test for os package</span>
describe package(<span class="string">'telnetd'</span>) <span class="keyword">do</span>
  it { should_not be_installed }
<span class="keyword">end</span>
</code></pre>
<p>InSpec <span class="caps">CLI</span> can easily execute this test locally or remotely&nbsp;with:</p>
<pre><code class="lang-bash"><span class="comment"># run test locally, local execution is implicit</span>
inspec <span class="built_in">exec</span> test.rb

<span class="comment"># run test on docker container</span>
inspec <span class="built_in">exec</span> test.rb -t docker://container_id
</code></pre>
<p>A test to verify that a <span class="caps">EC2</span> instance exists and is running is written as&nbsp;following:</p>
<pre><code class="lang-ruby"><span class="comment"># test for aws ec2</span>
describe aws_ec2_instance(<span class="string">'i-01a2349e94458a507'</span>) <span class="keyword">do</span>
  it { should exist }
  it { should be_running }
<span class="keyword">end</span>
</code></pre>
<p>Now, we target the <span class="caps">AWS</span> api instead of local, ssh, winrm or&nbsp;docker: </p>
<pre><code class="lang-bash"><span class="comment"># run a profile targeting <span class="caps">AWS</span> using env vars</span>
inspec <span class="built_in">exec</span> test.rb -t aws://
</code></pre>
<p>While the first example is a test for an operating system, the second is a test for the <span class="caps">AWS</span> API. They follow the same concepts, you either target your tests to an operating system or an AWS API. InSpec is smart enough to know that a resource works for a given&nbsp;target.</p>
<p><img src="/articles/inspec-cloud-aws-setup/images/inspec-exec-wrong-platform.png" alt="InSpec detects the target platform"></p>
<p>In case you just want to play with InSpec for testing, I recommend using my <code>inspec-playgroud</code> container, since it includes InSpec and <span class="caps">AWS</span>&nbsp;CLI:</p>
<pre><code class="lang-bash">$ docker run -it chrisrock/inspec-playground
[root@b7a17c8c6dd4 /]<span class="comment"># inspec version</span>
2.1.10
[root@b7a17c8c6dd4 /]<span class="comment"># aws --version</span>
aws-cli/1.14.63 Python/2.7.5 Linux/4.9.60-linuxkit-aufs botocore/1.9.16
</code></pre>
<h2 id="create-an-aws-iam-user">Create an <span class="caps">AWS</span> IAM&nbsp;user</h2>
<p>To allow InSpec to talk to <span class="caps">AWS</span>, we need to create an IAM user in AWS console. If you have credentials already, skip to the next <a href="#run-inspec-check">section</a>. The following commands are executed on Linux but work similar on Windows and macOS. If you’ve never run <span class="caps">AWS</span> cli before, you should see an error message&nbsp;like: </p>
<pre><code class="lang-bash">[root@b7a17c8c6dd4 /]<span class="comment"># aws iam get-user</span>
Unable to locate credentials. You can configure credentials by running <span class="string">"aws configure"</span>.
</code></pre>
<p>Create new credentials within the <a href="https://console.aws.amazon.com/iam/home#/users"><span class="caps">IAM</span> console</a> by clicking on “add user”. Now enter your username and select <code>programmatic access</code>.</p>
<p><img src="/articles/inspec-cloud-aws-setup/images/iam_create_user_01.png" alt="Create a new user"></p>
<p>As the second step, we need to provide permissions to the user. Since InSpec is for testing only, <code>ReadOnlyAccess</code> is all you&nbsp;need.</p>
<p><img src="/articles/inspec-cloud-aws-setup/images/iam_create_user_02.png" alt="Select IAM permissions"></p>
<p>Now, we need to confirm the&nbsp;configuration.</p>
<p><img src="/articles/inspec-cloud-aws-setup/images/iam_create_user_03.png" alt="Review configuration"></p>
<p>If everything goes well, you should see the confirmation page with the <span class="caps">AWS</span> Access Key and AWS Secret Access Key. Both are required for the next&nbsp;step.</p>
<p><img src="/articles/inspec-cloud-aws-setup/images/iam_create_user_04.png" alt="IAM user creation confirmation"></p>
<h2 id="configure-your-aws-cli">Configure your <span class="caps">AWS</span>&nbsp;CLI</h2>
<p>The <span class="caps">AWS</span> cli makes it very easy to configure AWS settings. InSpec is reading the same configuration files, therefore the AWS CLI works hand-in-hand with InSpec. No seperate configuration&nbsp;required.</p>
<pre><code class="lang-bash">[root@b7a17c8c6dd4 /]<span class="comment">#  aws configure</span>
<span class="caps">AWS</span> Access Key ID [None]:  AKIAXXXXXXXXXXXXXXXXX
AWS Secret Access Key [None]: l1g3J+BAI1EWyyWR4c5n5xxxxxxxxxxxxxxxx
Default region name [None]: us-east-1
Default output format [None]:
</code></pre>
<p>Now, the <code>aws</code> cli created two config&nbsp;files:</p>
<pre><code class="lang-bash">[root@b7a17c8c6dd4 /]<span class="comment"># ls ~/.aws/            </span>
config  credentials
[root@b7a17c8c6dd4 /]<span class="comment"># cat ~/.aws/config </span>
[default]
region = us-east-1
[root@b7a17c8c6dd4 /]<span class="comment"># cat ~/.aws/credentials </span>
[default]
aws_access_key_id =  <span class="caps">AKIAXXXXXXXXXXXXXXXXX</span>
aws_secret_access_key = l1g3J+BAI1EWyyWR4c5n5xxxxxxxxxxxxxxxx
</code></pre>
<p>Verify that <code>aws iam get-user</code> can connect to <span class="caps">AWS</span>. You get a response, everything is configure&nbsp;properly.</p>
<pre><code class="lang-bash">[root@b7a17c8c6dd4 /]<span class="comment"># aws iam get-user</span>
{
    <span class="string">"User"</span>: {
        <span class="string">"UserName"</span>: <span class="string">"chris-rock"</span>, 
        <span class="string">"Path"</span>: <span class="string">"/"</span>, 
        <span class="string">"CreateDate"</span>: <span class="string">"2018-03-27T12:06:32Z"</span>, 
        <span class="string">"UserId"</span>: <span class="string">"<span class="caps">AKIAXXXXXXXXXXXXXXXXX</span>"</span>, 
        <span class="string">"Arn"</span>: <span class="string">"arn:aws:iam::112758395563:user/chris-rock"</span>
    }
}
</code></pre>
<h1 id="run-first-aws-inspec-check">Run first <span class="caps">AWS</span> InSpec&nbsp;check</h1>
<p>InSpec does not rely on <span class="caps">AWS</span> cli. It re-uses the same configuration files located in <code>~/.aws/config</code> and <code>~/.aws/credentials</code> though. Since we configured them already, we are ready to&nbsp;go.</p>
<p>Let’s create a new InSpec test file <code>iam.rb</code> with the following&nbsp;content</p>
<pre><code class="lang-ruby">describe aws_iam_user(<span class="symbol">username:</span> <span class="string">'chris-rock'</span>) <span class="keyword">do</span>
    it { should have_mfa_enabled }
    it { should_not have_console_password }
<span class="keyword">end</span>
</code></pre>
<p>Execute that test with&nbsp;InSpec:</p>
<pre><code class="lang-bash">$ inspec <span class="built_in">exec</span> iam.rb -t aws://
</code></pre>
<p>And&nbsp;voilà!</p>
<p><img src="/articles/inspec-cloud-aws-setup/images/inspec-aws-run.png" alt="InSpec reports DevSec SSH Baseline to Chef Automate"></p>
<p>If you are using multiple <span class="caps">AWS</span> profiles you can define those in your <code>~/.aws/credentials</code> file.</p>
<pre><code class="lang-ini">$ cat ~/.aws/credentials 
[auditing]
aws_access_key_id = AKIA....
aws_secret_access_key = 1234....abcd
</code></pre>
<p>You can use the <span class="caps">AWS</span> profile as an option for the inspec target <code>-t aws://region/profile</code>. For example, to connect to the Ohio region using a profile named <code>auditing</code>, use <code>inspec exec iam.rb -t aws://us-east-2/auditing</code>. Please have a look look at the <a href="https://www.inspec.io/docs/reference/platforms/">InSpec Docs</a> for more&nbsp;information.</p>
<h2 id="summary">Summary</h2>
<p>Yeah! Within 5 minutes, we wrote our first InSpec test for <span class="caps">AWS</span>. InSpec ships with a lot of <a href="https://www.inspec.io/docs/reference/resources/#aws-resources">built-in <span class="caps">AWS</span> resources</a>. You may also be interested to combine <a href="http://lollyrock.com/articles/inspec-terraform/">Terraform with InSpec</a> as the next&nbsp;step.</p>
<p>Happy Wednesday! -&nbsp;Chris</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="social center">
          <div class="network"><a href="javascript:window.location=%22http://news.ycombinator.com/submitlink?u=%22+encodeURIComponent(document.location)+%22&amp;amp;t=%22+encodeURIComponent(document.title)" class="hn-link">Discuss on Hacker News</a></div>
          <div class="network twitter"><a https://twitter.com/share data-via="chri_hartmann" data-count="none" class="twitter-share-button">Tweet</a></div>
        </div>
        <div class="nav"><a href="/">« Full blog</a></div>
        <section class="about">
        </section>
        <section class="copy">
          <p>&copy; 2018 Christoph Hartmann &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>