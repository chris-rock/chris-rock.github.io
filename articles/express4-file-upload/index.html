<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="google-site-verification" content="iplyfI0Y6pOe8NsNYwwrKe-QfSYamSeEhQiDFh93NiU">
    <title>Simple file uploads with Express 4 - chris-rock
    </title>
    <link rel="alternate" href="http://lollyrock.com/feed.xml" type="application/rss+xml" title="fun &amp; sun">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50992958-1', 'lollyrock.com');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript">
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
      
    </script>
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Simple file uploads with Express 4</h1>
        <p class="author">Written by <span class="author"><a href="mailto:chris@lollyrock.com">Christoph Hartmann</a></span>
        </p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p><a href="http://expressjs.com/">Express</a> is a great web framework for Javascript. Quite often you have to deal with file uploads. Although this may seems like a trivial point, it has its challenges, especially if everything is&nbsp;asynchronous. </p>
<h2 id="using-busboy">Using&nbsp;Busboy</h2>
<p>For some time, <a href="https://github.com/mscdex/busboy">Busboy</a> was the best solution, because it uses the Javascript eventing properly. The downside is the complex setup as the sample from the github profile&nbsp;demonstrates:</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>),
    inspect = <span class="built_in">require</span>(<span class="string">'util'</span>).inspect;

<span class="keyword">var</span> Busboy = <span class="built_in">require</span>(<span class="string">'busboy'</span>);

http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>{
  <span class="keyword">if</span> (req.method === <span class="string">'<span class="caps">POST</span>'</span>) {
    <span class="keyword">var</span> busboy = <span class="keyword">new</span> Busboy({ <span class="attr">headers</span>: req.headers });
    busboy.on(<span class="string">'file'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">fieldname, file, filename, encoding, mimetype</span>) </span>{
      <span class="built_in">console</span>.log(<span class="string">'File ['</span> + fieldname + <span class="string">']: filename: '</span> + filename + <span class="string">', encoding: '</span> + encoding + <span class="string">', mimetype: '</span> + mimetype);
      file.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>{
        <span class="built_in">console</span>.log(<span class="string">'File ['</span> + fieldname + <span class="string">'] got '</span> + data.length + <span class="string">' bytes'</span>);
      });
      file.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
        <span class="built_in">console</span>.log(<span class="string">'File ['</span> + fieldname + <span class="string">'] Finished'</span>);
      });
    });
    busboy.on(<span class="string">'field'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">fieldname, val, fieldnameTruncated, valTruncated</span>) </span>{
      <span class="built_in">console</span>.log(<span class="string">'Field ['</span> + fieldname + <span class="string">']: value: '</span> + inspect(val));
    });
    busboy.on(<span class="string">'finish'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      <span class="built_in">console</span>.log(<span class="string">'Done parsing form!'</span>);
      res.writeHead(<span class="number">303</span>, { <span class="attr">Connection</span>: <span class="string">'close'</span>, <span class="attr">Location</span>: <span class="string">'/'</span> });
      res.end();
    });
    req.pipe(busboy);
  } <span class="keyword">else</span> <span class="keyword">if</span> (req.method === <span class="string">'<span class="caps">GET</span>'</span>) {
    res.writeHead(<span class="number">200</span>, { <span class="attr">Connection</span>: <span class="string">'close'</span> });
    res.end(<span class="string">'&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;\
               &lt;form method="<span class="caps">POST</span>" enctype="multipart/form-data"&gt;\
                &lt;input type="text" name="textfield"&gt;&lt;br /&gt;\
                &lt;input type="file" name="filefield"&gt;&lt;br /&gt;\
                &lt;input type="submit"&gt;\
              &lt;/form&gt;\
            &lt;/body&gt;&lt;/html&gt;'</span>);
  }
}).listen(<span class="number">8000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
  <span class="built_in">console</span>.log(<span class="string">'Listening for requests'</span>);
});
</code></pre>
<p>This is not fun if you need to support this complex setup for multiple routes in express. Do not get me wrong, busboy is a great module and does the job well, but it is just not the abstraction you would like to have in your project. In normal cases you <code>just</code> need a file&nbsp;upload.</p>
<h2 id="use-multer">Use&nbsp;multer</h2>
<p>Here comes <a href="https://github.com/expressjs/multer">multer</a>. The final piece that fits between express and busboy. It takes all complex tasks behind the scenes and offers a configurable express middleware. Letâ€™s try it&nbsp;out:</p>
<p>Set up a <code>package.json</code></p>
<pre><code class="lang-javascript">{
  <span class="string">"name"</span>: <span class="string">"expres-upload-test"</span>,
  <span class="string">"description"</span>: <span class="string">"simple form upload test"</span>,
  <span class="string">"version"</span>: <span class="string">"0.1.0"</span>,
  <span class="string">"dependencies"</span>: {
    <span class="string">"express"</span>: <span class="string">"~4.0.0"</span>,
    <span class="string">"multer"</span> : <span class="string">"0.1.6"</span>
  },
  <span class="string">"devDependencies"</span>: {
  },
  <span class="string">"scripts"</span>: {},
  <span class="string">"engines"</span>: {
    <span class="string">"node"</span>: <span class="string">"0.10.x"</span>,
    <span class="string">"npm"</span>: <span class="string">"&gt;1.4.0"</span>
  }
}
</code></pre>
<p>To implement the server, create a <code>server.js</code> that combines express with multer. It is 17 lines including an extra hello world&nbsp;route.</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>),
    multer  = <span class="built_in">require</span>(<span class="string">'multer'</span>)

<span class="keyword">var</span> app = express()
app.use(multer({ <span class="attr">dest</span>: <span class="string">'./uploads/'</span>}))

app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>{
  res.send(<span class="string">'hello world'</span>);
});

app.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>{
    <span class="built_in">console</span>.log(req.body) <span class="comment">// form fields</span>
    <span class="built_in">console</span>.log(req.files) <span class="comment">// form files</span>
    res.status(<span class="number">204</span>).end()
});

app.listen(<span class="number">3000</span>);
</code></pre>
<p>Of course you can try this by using <a href="https://github.com/jakubroztocil/httpie">httpie</a>:</p>
<pre><code class="lang-bash">$ http -f POST http://localhost:3000/ file@~/Downloads/test.pdf
HTTP/1.1 200 OK
Connection: keep-alive
Date: Sat, 15 Nov 2014 11:15:21 GMT
X-Powered-By: Express
content-length: 278
content-type: application/json

{
    <span class="string">"file"</span>: {
        <span class="string">"buffer"</span>: null, 
        <span class="string">"encoding"</span>: <span class="string">"7bit"</span>, 
        <span class="string">"extension"</span>: <span class="string">"pdf"</span>, 
        <span class="string">"fieldname"</span>: <span class="string">"file"</span>, 
        <span class="string">"mimetype"</span>: <span class="string">"text/plain"</span>, 
        <span class="string">"name"</span>: <span class="string">"f459076685288eed5b4b45f80a11b908.pdf"</span>, 
        <span class="string">"originalname"</span>: <span class="string">"test.pdf"</span>, 
        <span class="string">"path"</span>: <span class="string">"uploads/f459076685288eed5b4b45f80a11b908.pdf"</span>, 
        <span class="string">"size"</span>: 59353, 
        <span class="string">"truncated"</span>: <span class="literal">false</span>
    }
}
</code></pre>
<h2 id="upload-per-route">Upload per&nbsp;route</h2>
<p>The example above works well in most use cases. If you chain multiple middleware together, you will find out, that express uses streams, but this does not fully work with middleware. Events are not piped between middleware. If you use two express middlewares in a chain and each tries to catch all stream events and calls <code>next()</code> when all the eventing is done, the second middleware will not receive the required events&nbsp;anymore. </p>
<p>In such a case you need to optimize the middleware per route. Therefore I do not recommend to use multer as a global middleware for express. Instead I would add multer to the routes that specifically require&nbsp;it. </p>
<p>A working example would look&nbsp;like:</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>),
    multer  = <span class="built_in">require</span>(<span class="string">'multer'</span>)

<span class="keyword">var</span> app = express()

app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>{
  res.send(<span class="string">'hello world'</span>);
});

app.post(<span class="string">'/'</span>,[ multer({ <span class="attr">dest</span>: <span class="string">'./uploads/'</span>}), <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>{
    <span class="built_in">console</span>.log(req.body) <span class="comment">// form fields</span>
    <span class="built_in">console</span>.log(req.files) <span class="comment">// form files</span>
    res.status(<span class="number">204</span>).end()
}]);

app.listen(<span class="number">3000</span>);
</code></pre>
<p>If you have any questions contact me via <a href="https://twitter.com/chri_hartmann">Twitter @chri_hartmann</a> or <a href="https://github.com/chris-rock">Github</a></p>
<p>See&nbsp;also:</p>
<ul>
<li><a href="http://lollyrock.com/articles/nodejs-encryption/">Encrypt and decrypt content with&nbsp;Nodejs</a></li>
<li><a href="http://lollyrock.com/articles/nodejs-sha512/"><span class="caps">SHA</span> 512 Hashs with&nbsp;nodejs</a></li>
<li><a href="http://lollyrock.com/articles/content-security-policy/">Applied Content Security Policy for Nginx and&nbsp;Nodejs</a></li>
<li><a href="http://arlimus.github.io/articles/ready.for.es6/">Ready for&nbsp;<span class="caps">ES6</span>?</a></li>
</ul>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="social center">
          <div class="network"><a href="javascript:window.location=%22http://news.ycombinator.com/submitlink?u=%22+encodeURIComponent(document.location)+%22&amp;amp;t=%22+encodeURIComponent(document.title)" class="hn-link">Discuss on Hacker News</a></div>
          <div class="network twitter"><a https://twitter.com/share data-via="chri_hartmann" data-count="none" class="twitter-share-button">Tweet</a></div>
        </div>
        <div class="nav"><a href="/">Â« Full blog</a></div>
        <section class="about">
        </section>
        <section class="copy">
          <p>&copy; 2017 Christoph Hartmann &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>